<!doctype html><html lang=en-us><head><meta charset=utf-8><title>Techniques for solving four-bar linkage equations | Dan Aukes </title><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=description content="Dan Aukes' personal website"><meta name=author content="Dan Aukes"><meta name=generator content="Hugo 0.140.0"><link rel=stylesheet href=https://www.danaukes.com/plugins/glightbox/css/glightbox.css><link rel=stylesheet href=https://www.danaukes.com/plugins/bootstrap/bootstrap.min.css><link rel=stylesheet href=https://www.danaukes.com/plugins/slick/slick.css><link rel=stylesheet href=https://www.danaukes.com/plugins/themify-icons/themify-icons.css><link rel=stylesheet href=https://www.danaukes.com/plugins/venobox/venobox.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css><link rel=stylesheet href=https://www.danaukes.com/scss/style.min.css media=screen><link rel="shortcut icon" href=https://www.danaukes.com/images/favicon.png type=image/x-icon><link rel=icon href=https://www.danaukes.com/images/favicon.png type=image/x-icon><script>(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)})(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","","auto"),ga("send","pageview")</script><script>MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]],processEscapes:!0,processEnvironments:!0},options:{skipHtmlTags:["script","noscript","style","textarea","pre"]}},window.addEventListener("load",e=>{document.querySelectorAll("mjx-container").forEach(function(e){e.parentElement.classList+="has-jax"})})</script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script></head><body><div class=preloader></div><header class=navigation><div class=container><nav class="navbar navbar-expand-lg navbar-white bg-transparent border-bottom pl-0"><a class="navbar-brand mobile-view" href=https://www.danaukes.com/><img class=img-fluid src=https://www.danaukes.com/da-small.png alt="Dan Aukes"></a>
<button class="navbar-toggler border-0" type=button data-toggle=collapse data-target=#navigation>
<i class=ti-menu></i></button><div class="collapse navbar-collapse text-center" id=navigation><div class=desktop-view><ul class="navbar-nav mr-auto"><li class=nav-item><a class=nav-link href=https://github.com/danb0b><i class=ti-github></i></a></li><li class=nav-item><a class=nav-link href=https://www.linkedin.com/in/dan-aukes-502995212/><i class=ti-linkedin></i></a></li></ul></div><a class="navbar-brand mx-auto desktop-view" href=https://www.danaukes.com/><img class=img-fluid src=https://www.danaukes.com/da-small.png alt="Dan Aukes"></a><ul class=navbar-nav><li class=nav-item><a class=nav-link href=https://www.danaukes.com/work-blog/>Work Blog</a></li><li class=nav-item><a class=nav-link href=https://www.danaukes.com/notebook/>Notebook</a></li><li class=nav-item><a class=nav-link href=https://www.danaukes.com/travel/>Travel</a></li><li class=nav-item><a class=nav-link href=https://www.danaukes.com/recipes/>Recipes</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>Misc</a><div class=dropdown-menu><a class=dropdown-item href=https://www.danaukes.com/code/>Code</a>
<a class=dropdown-item href=https://www.danaukes.com/websites/>Websites</a>
<a class=dropdown-item href=https://www.danaukes.com/bookmarks/>Bookmarks</a></div></li></ul><form action=https://www.danaukes.com//search class=d-flex><input class="form-control me-2" id=search-query name=s type=s placeholder=Search aria-label=Search>
<button class="btn btn-outline-success" type=submit><i class="ti-search text-dark"></i></button></form></div></nav></div></header><section class=section-sm><div class=container><div class=row><div class="col-lg-8 mx-auto"><div class=text-center><nav aria-label=breadcrumb><ol class=breadcrumb><li class=breadcrumb-item><a href=https://www.danaukes.com/>Welcome</a></li><li class=breadcrumb-item><a href=https://www.danaukes.com/work-blog/>Work Blog</a></li><li class="breadcrumb-item active"><a href=https://www.danaukes.com/work-blog/2024-03-13-sympy-fourbar/>Techniques for solving four-bar linkage equations</a></li></ol></nav></div><h2>Techniques for solving four-bar linkage equations</h2><div class="mb-1 post-meta"><span>By Dan Aukes</span></div><ul class=list-inline></ul><div class="content mb-5"><h2 id=introduction>Introduction</h2><p>The purpose of this tutorial is to show you the power of sympy for analyzing the math of linkages and kinematics. We will walk through a full example of solving for the motion of a four-bar linkage, with a variety of approaches explored along the way with an eye towards addressing sympy&rsquo;s limitations, compared to other symbolic math environments like Mathematica, Maple, etc.</p><p>First, import all your libraries. Note that we want to use the symbolic form of sin and cos a lot, so we intentionally import those functions into our main namespace. Likewise, we want to use the numeric value of pi often, so we can import that directly from the math package.</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>sympy</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>sympy</span> <span style=color:#f92672>import</span> <span style=color:#111>sin</span><span style=color:#111>,</span><span style=color:#111>cos</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>math</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>math</span> <span style=color:#f92672>import</span> <span style=color:#111>pi</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>numpy</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>scipy</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>matplotlib.pyplot</span> <span style=color:#00a8c8>as</span> <span style=color:#111>plt</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>scipy.optimize</span> <span style=color:#00a8c8>as</span> <span style=color:#111>so</span>
</span></span></code></pre></div><p>You can create multiple symbols at a time, with latex formatting. if you want to use the backslash, however, remember that the backslash in Python is used for non-printing characters like <code>\n</code> and <code>\t</code>. Therefore, to &ldquo;escape&rdquo; that default, you have to use two backslashes. What would normally be <code>\theta</code> in latex should be <code>\\theta</code> in a Python string.</p><p>Separate your separate symbols in the string with spaces or commas, and make sure each one has its own Python variable that it is saved to.</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>qa</span><span style=color:#111>,</span><span style=color:#111>qb</span><span style=color:#111>,</span><span style=color:#111>qc</span><span style=color:#111>,</span><span style=color:#111>qd</span> <span style=color:#f92672>=</span> <span style=color:#111>sympy</span><span style=color:#f92672>.</span><span style=color:#111>symbols</span><span style=color:#111>(</span><span style=color:#d88200>&#39;</span><span style=color:#8045ff>\\</span><span style=color:#d88200>theta_a,</span><span style=color:#8045ff>\\</span><span style=color:#d88200>theta_b,</span><span style=color:#8045ff>\\</span><span style=color:#d88200>theta_c,</span><span style=color:#8045ff>\\</span><span style=color:#d88200>theta_d&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>la</span><span style=color:#111>,</span><span style=color:#111>lb</span><span style=color:#111>,</span><span style=color:#111>lc</span><span style=color:#111>,</span><span style=color:#111>ld</span> <span style=color:#f92672>=</span> <span style=color:#111>sympy</span><span style=color:#f92672>.</span><span style=color:#111>symbols</span><span style=color:#111>(</span><span style=color:#d88200>&#39;l_a,l_b,l_c,l_d&#39;</span><span style=color:#111>)</span>
</span></span></code></pre></div><p>We can test what was produced to see how it formats in a Jupyter notebook. Pretty!</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>qa</span>
</span></span></code></pre></div><p>$\displaystyle \theta_{a}$</p><p>Next, we define a function to create rotation matrices with the rotation about the z axis. We are doing a planar example, so we only need a $R_z$ matrices. The function allows us to generate multiple rotation matrices, with different variables controlling the rotation amount, using the same code. Efficient!</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>Rz</span><span style=color:#111>(</span><span style=color:#111>theta</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#111>Rz</span> <span style=color:#f92672>=</span> <span style=color:#111>sympy</span><span style=color:#f92672>.</span><span style=color:#111>Matrix</span><span style=color:#111>([[</span><span style=color:#111>cos</span><span style=color:#111>(</span><span style=color:#111>theta</span><span style=color:#111>),</span><span style=color:#f92672>-</span><span style=color:#111>sin</span><span style=color:#111>(</span><span style=color:#111>theta</span><span style=color:#111>),</span><span style=color:#ae81ff>0</span><span style=color:#111>],[</span><span style=color:#111>sin</span><span style=color:#111>(</span><span style=color:#111>theta</span><span style=color:#111>),</span><span style=color:#111>cos</span><span style=color:#111>(</span><span style=color:#111>theta</span><span style=color:#111>),</span><span style=color:#ae81ff>0</span><span style=color:#111>],[</span><span style=color:#ae81ff>0</span><span style=color:#111>,</span><span style=color:#ae81ff>0</span><span style=color:#111>,</span><span style=color:#ae81ff>1</span><span style=color:#111>]])</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>Rz</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>Ra</span> <span style=color:#f92672>=</span> <span style=color:#111>Rz</span><span style=color:#111>(</span><span style=color:#111>qa</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>Rb</span> <span style=color:#f92672>=</span> <span style=color:#111>Rz</span><span style=color:#111>(</span><span style=color:#111>qb</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>Rc</span> <span style=color:#f92672>=</span> <span style=color:#111>Rz</span><span style=color:#111>(</span><span style=color:#111>qc</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>Rd</span> <span style=color:#f92672>=</span> <span style=color:#111>Rz</span><span style=color:#111>(</span><span style=color:#111>qd</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>Ra</span>
</span></span></code></pre></div><p>$\displaystyle \left[\begin{matrix}\cos{\left(\theta_{a} \right)} & - \sin{\left(\theta_{a} \right)} & 0 \\ \sin{\left(\theta_{a} \right)} & \cos{\left(\theta_{a} \right)} & 0 \\ 0 & 0 & 1\end{matrix}\right]$</p><p>Next, create a Cartesian unit vector in the x direction. This is a generic unit vector variable that is not associated with any frame, so we can just call it x</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>x</span> <span style=color:#f92672>=</span> <span style=color:#111>sympy</span><span style=color:#f92672>.</span><span style=color:#111>Matrix</span><span style=color:#111>([</span><span style=color:#ae81ff>1</span><span style=color:#111>,</span><span style=color:#ae81ff>0</span><span style=color:#111>,</span><span style=color:#ae81ff>0</span><span style=color:#111>])</span>
</span></span><span style=display:flex><span><span style=color:#111>x</span>
</span></span></code></pre></div><p>$\displaystyle \left[\begin{matrix}1\\0\\0\end{matrix}\right]$</p><p>Now, let&rsquo;s create a vector $\vec{v}_1$, defined as the length of the A link, along the x-axis in the A frame. We need to transform it into the N frame (our base frame) in order to relate it to other vectors.</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>v1_in_A</span> <span style=color:#f92672>=</span> <span style=color:#111>(</span><span style=color:#111>la</span><span style=color:#f92672>*</span><span style=color:#111>x</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>v1_in_N</span> <span style=color:#f92672>=</span> <span style=color:#111>Ra</span><span style=color:#f92672>*</span><span style=color:#111>v1_in_A</span>
</span></span><span style=display:flex><span><span style=color:#111>v1_in_N</span>
</span></span></code></pre></div><p>$\displaystyle \left[\begin{matrix}l_{a} \cos{\left(\theta_{a} \right)}\\l_{a} \sin{\left(\theta_{a} \right)}\\0\end{matrix}\right]$</p><p>We can use a dictionary to substitute numerical values for the symbolic variables. This is useful for plotting and solving specific problems</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>v1_in_N</span><span style=color:#f92672>.</span><span style=color:#111>subs</span><span style=color:#111>({</span><span style=color:#111>qa</span><span style=color:#111>:</span><span style=color:#ae81ff>91</span><span style=color:#f92672>*</span><span style=color:#111>pi</span><span style=color:#f92672>/</span><span style=color:#ae81ff>180</span><span style=color:#111>,</span><span style=color:#111>la</span><span style=color:#111>:</span><span style=color:#ae81ff>1</span><span style=color:#111>})</span>
</span></span></code></pre></div><p>$\displaystyle \left[\begin{matrix}-0.0174524064372835\\0.999847695156391\\0\end{matrix}\right]$</p><p>We can now define the remaining vectors of the four-bar in the same way. $\vec{v}_2$ is the distance along link B, from the end of link A. Its rotation is relative to the rotation of link A. Therefore, to express it in the N(base) frame, we need to express it first in terms of A, then N.</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>v2_in_B</span> <span style=color:#f92672>=</span> <span style=color:#111>lb</span><span style=color:#f92672>*</span><span style=color:#111>x</span>
</span></span><span style=display:flex><span><span style=color:#111>v2_in_A</span> <span style=color:#f92672>=</span> <span style=color:#111>Rb</span><span style=color:#f92672>*</span><span style=color:#111>v2_in_B</span>
</span></span><span style=display:flex><span><span style=color:#111>v2_in_N</span> <span style=color:#f92672>=</span> <span style=color:#111>Ra</span><span style=color:#f92672>*</span><span style=color:#111>v2_in_A</span>
</span></span><span style=display:flex><span><span style=color:#111>v2_in_N</span>
</span></span></code></pre></div><p>$\displaystyle \left[\begin{matrix}- l_{b} \sin{\left(\theta_{a} \right)} \sin{\left(\theta_{b} \right)} + l_{b} \cos{\left(\theta_{a} \right)} \cos{\left(\theta_{b} \right)}\\l_{b} \sin{\left(\theta_{a} \right)} \cos{\left(\theta_{b} \right)} + l_{b} \sin{\left(\theta_{b} \right)} \cos{\left(\theta_{a} \right)}\\0\end{matrix}\right]$</p><p>$\vec{v}_3$ represents link C. It rotates relative to the base frame.</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>v3_in_C</span> <span style=color:#f92672>=</span> <span style=color:#111>lc</span><span style=color:#f92672>*</span><span style=color:#111>x</span>
</span></span><span style=display:flex><span><span style=color:#111>v3_in_N</span> <span style=color:#f92672>=</span> <span style=color:#111>Rc</span><span style=color:#f92672>*</span><span style=color:#111>v3_in_C</span>
</span></span><span style=display:flex><span><span style=color:#111>v3_in_N</span>
</span></span></code></pre></div><p>$\displaystyle \left[\begin{matrix}l_{c} \cos{\left(\theta_{c} \right)}\\l_{c} \sin{\left(\theta_{c} \right)}\\0\end{matrix}\right]$</p><p>Like link B, link D rotates relative to link C. $\vec{v}_4$ represents link D, and it needs to be expressed first in C, and then in N, in order to relate it to other vectors</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>v4_in_D</span> <span style=color:#f92672>=</span> <span style=color:#111>ld</span><span style=color:#f92672>*</span><span style=color:#111>x</span>
</span></span><span style=display:flex><span><span style=color:#111>v4_in_C</span> <span style=color:#f92672>=</span> <span style=color:#111>Rd</span><span style=color:#f92672>*</span><span style=color:#111>v4_in_D</span>
</span></span><span style=display:flex><span><span style=color:#111>v4_in_N</span> <span style=color:#f92672>=</span> <span style=color:#111>Rc</span><span style=color:#f92672>*</span><span style=color:#111>v4_in_C</span>
</span></span><span style=display:flex><span><span style=color:#111>v4_in_N</span>
</span></span></code></pre></div><p>$\displaystyle \left[\begin{matrix}- l_{d} \sin{\left(\theta_{c} \right)} \sin{\left(\theta_{d} \right)} + l_{d} \cos{\left(\theta_{c} \right)} \cos{\left(\theta_{d} \right)}\\l_{d} \sin{\left(\theta_{c} \right)} \cos{\left(\theta_{d} \right)} + l_{d} \sin{\left(\theta_{d} \right)} \cos{\left(\theta_{c} \right)}\\0\end{matrix}\right]$</p><p>$\vec{v}_1$,$\vec{v}_2$,$\vec{v}_3$, and $\vec{v}_4$ are all relative vectors relating the positon of the end-effector of their links from their origin. To express their absolute position, we define $\vec{p}_1$ - $\vec{p}_4$ to express the absolute position of each joint in global space. The position of these points is all related to some origin point, $\vec{o}$ which we also define.</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>o</span> <span style=color:#f92672>=</span> <span style=color:#111>sympy</span><span style=color:#f92672>.</span><span style=color:#111>Matrix</span><span style=color:#111>([</span><span style=color:#ae81ff>0</span><span style=color:#111>,</span><span style=color:#ae81ff>0</span><span style=color:#111>,</span><span style=color:#ae81ff>0</span><span style=color:#111>])</span>
</span></span><span style=display:flex><span><span style=color:#111>p1</span> <span style=color:#f92672>=</span> <span style=color:#111>o</span><span style=color:#f92672>+</span><span style=color:#111>v1_in_N</span>
</span></span><span style=display:flex><span><span style=color:#111>p2</span> <span style=color:#f92672>=</span> <span style=color:#111>o</span><span style=color:#f92672>+</span><span style=color:#111>p1</span><span style=color:#f92672>+</span><span style=color:#111>v2_in_N</span>
</span></span><span style=display:flex><span><span style=color:#111>p3</span> <span style=color:#f92672>=</span> <span style=color:#111>o</span><span style=color:#f92672>+</span><span style=color:#111>v3_in_N</span>
</span></span><span style=display:flex><span><span style=color:#111>p4</span> <span style=color:#f92672>=</span> <span style=color:#111>o</span><span style=color:#f92672>+</span><span style=color:#111>p3</span><span style=color:#f92672>+</span><span style=color:#111>v4_in_N</span>
</span></span></code></pre></div><p>Assembling each point permits us to plot the mechanism. We create a variable called points, which holds a list of each point in a particular order convenient for plotting (between each of the points listed, we want to draw a line).</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>points</span> <span style=color:#f92672>=</span> <span style=color:#111>sympy</span><span style=color:#f92672>.</span><span style=color:#111>Matrix</span><span style=color:#111>([</span><span style=color:#111>p2</span><span style=color:#f92672>.</span><span style=color:#111>T</span><span style=color:#111>,</span><span style=color:#111>p1</span><span style=color:#f92672>.</span><span style=color:#111>T</span><span style=color:#111>,</span><span style=color:#111>o</span><span style=color:#f92672>.</span><span style=color:#111>T</span><span style=color:#111>,</span><span style=color:#111>p3</span><span style=color:#f92672>.</span><span style=color:#111>T</span><span style=color:#111>,</span><span style=color:#111>p4</span><span style=color:#f92672>.</span><span style=color:#111>T</span><span style=color:#111>])</span><span style=color:#f92672>.</span><span style=color:#111>T</span>
</span></span><span style=display:flex><span><span style=color:#111>points</span>
</span></span></code></pre></div><p>$\displaystyle \left[\begin{matrix}l_{a} \cos{\left(\theta_{a} \right)} - l_{b} \sin{\left(\theta_{a} \right)} \sin{\left(\theta_{b} \right)} + l_{b} \cos{\left(\theta_{a} \right)} \cos{\left(\theta_{b} \right)} & l_{a} \cos{\left(\theta_{a} \right)} & 0 & l_{c} \cos{\left(\theta_{c} \right)} & l_{c} \cos{\left(\theta_{c} \right)} - l_{d} \sin{\left(\theta_{c} \right)} \sin{\left(\theta_{d} \right)} + l_{d} \cos{\left(\theta_{c} \right)} \cos{\left(\theta_{d} \right)}\\l_{a} \sin{\left(\theta_{a} \right)} + l_{b} \sin{\left(\theta_{a} \right)} \cos{\left(\theta_{b} \right)} + l_{b} \sin{\left(\theta_{b} \right)} \cos{\left(\theta_{a} \right)} & l_{a} \sin{\left(\theta_{a} \right)} & 0 & l_{c} \sin{\left(\theta_{c} \right)} & l_{c} \sin{\left(\theta_{c} \right)} + l_{d} \sin{\left(\theta_{c} \right)} \cos{\left(\theta_{d} \right)} + l_{d} \sin{\left(\theta_{d} \right)} \cos{\left(\theta_{c} \right)}\\0 & 0 & 0 & 0 & 0\end{matrix}\right]$</p><p>We now want to plot the mechansim. We define two variables: design and state. Design is intended to hold all our &mldr; &ldquo;design&rdquo; variables and you guessed it, state holds our &ldquo;state&rdquo; variables. Because we have, so far, a serial mechanism, all the rotations define the state of this open chain.</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>design</span> <span style=color:#f92672>=</span> <span style=color:#111>{</span><span style=color:#111>la</span><span style=color:#111>:</span><span style=color:#ae81ff>1.2</span><span style=color:#111>,</span><span style=color:#111>lb</span><span style=color:#111>:</span><span style=color:#ae81ff>.9</span><span style=color:#111>,</span><span style=color:#111>lc</span><span style=color:#111>:</span><span style=color:#ae81ff>1.1</span><span style=color:#111>,</span><span style=color:#111>ld</span><span style=color:#111>:</span><span style=color:#ae81ff>1.1</span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>state</span> <span style=color:#f92672>=</span> <span style=color:#111>{</span><span style=color:#111>qa</span><span style=color:#111>:</span><span style=color:#ae81ff>0</span><span style=color:#f92672>*</span><span style=color:#111>pi</span><span style=color:#f92672>/</span><span style=color:#ae81ff>180</span><span style=color:#111>,</span><span style=color:#111>qb</span><span style=color:#111>:</span><span style=color:#ae81ff>30</span><span style=color:#f92672>*</span><span style=color:#111>pi</span><span style=color:#f92672>/</span><span style=color:#ae81ff>180</span><span style=color:#111>,</span><span style=color:#111>qc</span><span style=color:#111>:</span><span style=color:#ae81ff>45</span><span style=color:#f92672>*</span><span style=color:#111>pi</span><span style=color:#f92672>/</span><span style=color:#ae81ff>180</span><span style=color:#111>,</span><span style=color:#111>qd</span><span style=color:#111>:</span><span style=color:#f92672>-</span><span style=color:#ae81ff>30</span><span style=color:#f92672>*</span><span style=color:#111>pi</span><span style=color:#f92672>/</span><span style=color:#ae81ff>180</span><span style=color:#111>}</span>
</span></span></code></pre></div><p>We substitute our design and state variables into <code>points</code> and plot the x and y coordinates</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>points_n</span> <span style=color:#f92672>=</span> <span style=color:#111>points</span><span style=color:#f92672>.</span><span style=color:#111>subs</span><span style=color:#111>({</span><span style=color:#f92672>**</span><span style=color:#111>design</span><span style=color:#111>,</span><span style=color:#f92672>**</span><span style=color:#111>state</span><span style=color:#111>})</span>
</span></span><span style=display:flex><span><span style=color:#111>points_n</span> <span style=color:#f92672>=</span> <span style=color:#111>numpy</span><span style=color:#f92672>.</span><span style=color:#111>array</span><span style=color:#111>(</span><span style=color:#111>points_n</span><span style=color:#111>,</span><span style=color:#111>dtype</span> <span style=color:#f92672>=</span> <span style=color:#111>numpy</span><span style=color:#f92672>.</span><span style=color:#111>float64</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>plt</span><span style=color:#f92672>.</span><span style=color:#111>plot</span><span style=color:#111>(</span><span style=color:#f92672>*</span><span style=color:#111>points_n</span><span style=color:#111>[:</span><span style=color:#ae81ff>2</span><span style=color:#111>])</span>
</span></span><span style=display:flex><span><span style=color:#111>plt</span><span style=color:#f92672>.</span><span style=color:#111>axis</span><span style=color:#111>(</span><span style=color:#d88200>&#39;equal&#39;</span><span style=color:#111>)</span>
</span></span></code></pre></div><pre><code>(-0.09897114317029974,
 2.0783940065762945,
 -0.053125920445898756,
 1.1156443293638738)
</code></pre><figure><img src=/work-blog/2024-03-13-sympy-fourbar/output_27_1.png></figure><h2 id=solving-closed-loop-constraints>Solving closed loop constraints</h2><p>We would now like to use these expressions to solve for a valid configuration where the four-bar linkage is closed. This means that $\vec{p}_2$ and $\vec{p}_4$ are located at the same spot. In general, we can create a <em>constraint equation</em> that represents that condition, and then solve for our remaining free variables in order to find a valid configuration. First we define our expression:</p><p>$$\vec{p}_2=\vec{p}_4$$</p><p>This useful for written math, but using sympy we need to eliminate the equals sign. Thus, we rewrite it as</p><p>$$0=\vec{p}_4-\vec{p}_2$$</p><p>and create a variable <code>zero</code> that holds this equation&rsquo;s right hand side, truncating the trivial z-axis information:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>zero</span> <span style=color:#f92672>=</span> <span style=color:#111>p4</span><span style=color:#f92672>-</span><span style=color:#111>p2</span>
</span></span><span style=display:flex><span><span style=color:#111>zero</span> <span style=color:#f92672>=</span> <span style=color:#111>sympy</span><span style=color:#f92672>.</span><span style=color:#111>Matrix</span><span style=color:#111>(</span><span style=color:#111>zero</span><span style=color:#111>[:</span><span style=color:#ae81ff>2</span><span style=color:#111>])</span>
</span></span><span style=display:flex><span><span style=color:#111>zero</span>
</span></span></code></pre></div><p>$\displaystyle \left[\begin{matrix}- l_{a} \cos{\left(\theta_{a} \right)} + l_{b} \sin{\left(\theta_{a} \right)} \sin{\left(\theta_{b} \right)} - l_{b} \cos{\left(\theta_{a} \right)} \cos{\left(\theta_{b} \right)} + l_{c} \cos{\left(\theta_{c} \right)} - l_{d} \sin{\left(\theta_{c} \right)} \sin{\left(\theta_{d} \right)} + l_{d} \cos{\left(\theta_{c} \right)} \cos{\left(\theta_{d} \right)}\\- l_{a} \sin{\left(\theta_{a} \right)} - l_{b} \sin{\left(\theta_{a} \right)} \cos{\left(\theta_{b} \right)} - l_{b} \sin{\left(\theta_{b} \right)} \cos{\left(\theta_{a} \right)} + l_{c} \sin{\left(\theta_{c} \right)} + l_{d} \sin{\left(\theta_{c} \right)} \cos{\left(\theta_{d} \right)} + l_{d} \sin{\left(\theta_{d} \right)} \cos{\left(\theta_{c} \right)}\end{matrix}\right]$</p><p>We now need to define some other variables. First, we need to &ldquo;fix&rdquo; the base of the four-bar linkage. In the case of this four-bar, it makes sense to define the A link as fixed to the ground, with $\theta_a=0$. Thus, we move <code>qa</code> into our list of &ldquo;design&rdquo; variables rather than state variables, since it never changes in our analysis</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>design</span> <span style=color:#f92672>=</span> <span style=color:#111>{</span><span style=color:#111>qa</span><span style=color:#111>:</span><span style=color:#ae81ff>0</span><span style=color:#111>,</span><span style=color:#f92672>**</span><span style=color:#111>design</span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>design</span>
</span></span></code></pre></div><pre><code>{\theta_a: 0, l_a: 1.2, l_b: 0.9, l_c: 1.1, l_d: 1.1}
</code></pre><p>We now substitute our design variables into <code>zero</code> to create a specific case of our solution.</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>zero_specific</span><span style=color:#f92672>=</span><span style=color:#111>zero</span><span style=color:#f92672>.</span><span style=color:#111>subs</span><span style=color:#111>(</span><span style=color:#111>design</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>zero_specific</span> <span style=color:#f92672>=</span> <span style=color:#111>sympy</span><span style=color:#f92672>.</span><span style=color:#111>Matrix</span><span style=color:#111>(</span><span style=color:#111>zero_specific</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>zero_specific</span>
</span></span></code></pre></div><p>$\displaystyle \left[\begin{matrix}- 1.1 \sin{\left(\theta_{c} \right)} \sin{\left(\theta_{d} \right)} - 0.9 \cos{\left(\theta_{b} \right)} + 1.1 \cos{\left(\theta_{c} \right)} \cos{\left(\theta_{d} \right)} + 1.1 \cos{\left(\theta_{c} \right)} - 1.2\\- 0.9 \sin{\left(\theta_{b} \right)} + 1.1 \sin{\left(\theta_{c} \right)} \cos{\left(\theta_{d} \right)} + 1.1 \sin{\left(\theta_{c} \right)} + 1.1 \sin{\left(\theta_{d} \right)} \cos{\left(\theta_{c} \right)}\end{matrix}\right]$</p><p>how many variables still exist in these equations? we can use the <code>.atoms()</code> method to find out</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>zero_specific</span><span style=color:#f92672>.</span><span style=color:#111>atoms</span><span style=color:#111>(</span><span style=color:#111>sympy</span><span style=color:#f92672>.</span><span style=color:#111>Symbol</span><span style=color:#111>)</span>
</span></span></code></pre></div><pre><code>{\theta_b, \theta_c, \theta_d}
</code></pre><p>But we have only two nontrivial equations and three unknowns! How do we solve for all three? Well, this helps us understand how many degrees of freedom exist in this system. One of these variables is a free parameter (also known as an independent variable), which we can select. The other two are dependent variables, which are determined by the independent variable. Let&rsquo;s supply our independent variable so that the remaining equations can be solved. Let&rsquo;s pick $\theta_b$</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>independent</span><span style=color:#f92672>=</span><span style=color:#111>{</span><span style=color:#111>qb</span><span style=color:#111>:</span><span style=color:#ae81ff>120</span><span style=color:#f92672>*</span><span style=color:#111>pi</span><span style=color:#f92672>/</span><span style=color:#ae81ff>180</span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>zero_specific</span><span style=color:#f92672>=</span><span style=color:#111>zero_specific</span><span style=color:#f92672>.</span><span style=color:#111>subs</span><span style=color:#111>(</span><span style=color:#111>independent</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>zero_specific</span>
</span></span></code></pre></div><p>$\displaystyle \left[\begin{matrix}- 1.1 \sin{\left(\theta_{c} \right)} \sin{\left(\theta_{d} \right)} + 1.1 \cos{\left(\theta_{c} \right)} \cos{\left(\theta_{d} \right)} + 1.1 \cos{\left(\theta_{c} \right)} - 0.75\\1.1 \sin{\left(\theta_{c} \right)} \cos{\left(\theta_{d} \right)} + 1.1 \sin{\left(\theta_{c} \right)} + 1.1 \sin{\left(\theta_{d} \right)} \cos{\left(\theta_{c} \right)} - 0.779422863405995\end{matrix}\right]$</p><h3 id=numerical-solving-process>Numerical Solving process</h3><p>We are first going to use a numerical approach to solving this problem, using the scipy.optimize package.</p><p>We now want to provide an initial guess for our two remaining dependent variables, $\theta_c$ and $\theta_d$, and a function that calculates the error of a guess for $\theta_c$ and $\theta_d$. We do this by supplying <code>zero</code> with a guess for $\theta_c$ and $\theta_d$, and computing the sum of squared error on the &ldquo;residual&rdquo;. Residual basically means the error between our computed answer and what it should be, 0.</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>ini</span> <span style=color:#f92672>=</span> <span style=color:#111>[</span><span style=color:#ae81ff>45</span><span style=color:#f92672>*</span><span style=color:#111>math</span><span style=color:#f92672>.</span><span style=color:#111>pi</span><span style=color:#f92672>/</span><span style=color:#ae81ff>180</span><span style=color:#111>,</span><span style=color:#f92672>-</span><span style=color:#ae81ff>45</span><span style=color:#f92672>*</span><span style=color:#111>math</span><span style=color:#f92672>.</span><span style=color:#111>pi</span><span style=color:#f92672>/</span><span style=color:#ae81ff>180</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>myfun</span><span style=color:#111>(</span><span style=color:#111>guess</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#111>qc_guess</span><span style=color:#111>,</span><span style=color:#111>qd_guess</span> <span style=color:#f92672>=</span> <span style=color:#111>guess</span>
</span></span><span style=display:flex><span>    <span style=color:#111>zero_guess</span> <span style=color:#f92672>=</span> <span style=color:#111>zero_specific</span><span style=color:#f92672>.</span><span style=color:#111>subs</span><span style=color:#111>({</span><span style=color:#111>qc</span><span style=color:#111>:</span><span style=color:#111>qc_guess</span><span style=color:#111>,</span><span style=color:#111>qd</span><span style=color:#111>:</span><span style=color:#111>qd_guess</span><span style=color:#111>})</span>
</span></span><span style=display:flex><span>    <span style=color:#111>zero_guess_n</span> <span style=color:#f92672>=</span> <span style=color:#111>numpy</span><span style=color:#f92672>.</span><span style=color:#111>array</span><span style=color:#111>(</span><span style=color:#111>zero_guess</span><span style=color:#111>,</span><span style=color:#111>dtype</span> <span style=color:#f92672>=</span> <span style=color:#111>numpy</span><span style=color:#f92672>.</span><span style=color:#111>float64</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>sum_of_squared_error</span> <span style=color:#f92672>=</span> <span style=color:#111>((</span><span style=color:#111>zero_guess_n</span><span style=color:#f92672>**</span><span style=color:#ae81ff>2</span><span style=color:#111>)</span><span style=color:#f92672>.</span><span style=color:#111>sum</span><span style=color:#111>())</span><span style=color:#f92672>**</span><span style=color:#ae81ff>.5</span>        
</span></span><span style=display:flex><span>    <span style=color:#75715e># print(guess,sum_of_squared_error)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>sum_of_squared_error</span>
</span></span></code></pre></div><p>we now supply our guess and function to the scipy.optimize.minimize() function, which can be used to identify the guess for $\theta_c$ and $\theta_d$ that minimizes the error</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>res</span> <span style=color:#f92672>=</span> <span style=color:#111>so</span><span style=color:#f92672>.</span><span style=color:#111>minimize</span><span style=color:#111>(</span><span style=color:#111>myfun</span><span style=color:#111>,</span><span style=color:#111>ini</span><span style=color:#111>,</span><span style=color:#111>method</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;powell&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>res</span>
</span></span></code></pre></div><pre><code> message: Optimization terminated successfully.
 success: True
  status: 0
     fun: 3.2518256220118898e-12
       x: [ 1.861e+00 -2.114e+00]
     nit: 7
   direc: [[ 0.000e+00  1.000e+00]
           [ 1.524e-01 -6.886e-02]]
    nfev: 297
</code></pre><p>Within the result we see a couple things. First, we see if the optimization process was successful. It says so. Second, we see <code>res.fun</code>, which indicates the magnitude of the residual error after our final guess, which is incredibly small. Finally, we see <code>res.x</code>, indicating the solution the solver found. We insert x into a dictionary</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>dependent</span> <span style=color:#f92672>=</span> <span style=color:#111>dict</span><span style=color:#111>(</span><span style=color:#111>zip</span><span style=color:#111>([</span><span style=color:#111>qc</span><span style=color:#111>,</span><span style=color:#111>qd</span><span style=color:#111>],</span><span style=color:#111>res</span><span style=color:#f92672>.</span><span style=color:#111>x</span><span style=color:#111>))</span>
</span></span></code></pre></div><p>and plot:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>points_n</span> <span style=color:#f92672>=</span> <span style=color:#111>points</span><span style=color:#f92672>.</span><span style=color:#111>subs</span><span style=color:#111>({</span><span style=color:#f92672>**</span><span style=color:#111>design</span><span style=color:#111>,</span><span style=color:#f92672>**</span><span style=color:#111>independent</span><span style=color:#111>,</span><span style=color:#f92672>**</span><span style=color:#111>dependent</span><span style=color:#111>})</span>
</span></span><span style=display:flex><span><span style=color:#111>points_n</span> <span style=color:#f92672>=</span> <span style=color:#111>numpy</span><span style=color:#f92672>.</span><span style=color:#111>array</span><span style=color:#111>(</span><span style=color:#111>points_n</span><span style=color:#111>,</span><span style=color:#111>dtype</span> <span style=color:#f92672>=</span> <span style=color:#111>numpy</span><span style=color:#f92672>.</span><span style=color:#111>float64</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>plt</span><span style=color:#f92672>.</span><span style=color:#111>plot</span><span style=color:#111>(</span><span style=color:#f92672>*</span><span style=color:#111>points_n</span><span style=color:#111>[:</span><span style=color:#ae81ff>2</span><span style=color:#111>])</span>
</span></span><span style=display:flex><span><span style=color:#111>plt</span><span style=color:#f92672>.</span><span style=color:#111>axis</span><span style=color:#111>(</span><span style=color:#d88200>&#39;equal&#39;</span><span style=color:#111>)</span>
</span></span></code></pre></div><pre><code>(-0.390973836659514,
 1.2757606588885482,
 -0.052693468583865546,
 1.1065628402611765)
</code></pre><figure><img src=/work-blog/2024-03-13-sympy-fourbar/output_45_1.png></figure><p>But what if we want to find the solution using a different design, or different value for our independent variable? We need to generate a different function before solving. We can do this by wrapping function generation within another function.</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>gen_fun</span><span style=color:#111>(</span><span style=color:#111>design</span><span style=color:#111>,</span><span style=color:#111>independent</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#111>zero_specific</span> <span style=color:#f92672>=</span> <span style=color:#111>zero</span><span style=color:#f92672>.</span><span style=color:#111>subs</span><span style=color:#111>({</span><span style=color:#f92672>**</span><span style=color:#111>design</span><span style=color:#111>,</span><span style=color:#f92672>**</span><span style=color:#111>independent</span><span style=color:#111>})</span>
</span></span><span style=display:flex><span>    <span style=color:#111>zero_specific</span> <span style=color:#f92672>=</span> <span style=color:#111>sympy</span><span style=color:#f92672>.</span><span style=color:#111>Matrix</span><span style=color:#111>(</span><span style=color:#111>zero_specific</span><span style=color:#111>[:</span><span style=color:#ae81ff>2</span><span style=color:#111>])</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>def</span> <span style=color:#75af00>fun</span><span style=color:#111>(</span><span style=color:#111>guess</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>        <span style=color:#111>qc_guess</span><span style=color:#111>,</span><span style=color:#111>qd_guess</span> <span style=color:#f92672>=</span> <span style=color:#111>guess</span>
</span></span><span style=display:flex><span>        <span style=color:#111>zero_guess</span> <span style=color:#f92672>=</span> <span style=color:#111>zero_specific</span><span style=color:#f92672>.</span><span style=color:#111>subs</span><span style=color:#111>({</span><span style=color:#111>qc</span><span style=color:#111>:</span><span style=color:#111>qc_guess</span><span style=color:#111>,</span><span style=color:#111>qd</span><span style=color:#111>:</span><span style=color:#111>qd_guess</span><span style=color:#111>})</span>
</span></span><span style=display:flex><span>        <span style=color:#111>zero_guess_n</span> <span style=color:#f92672>=</span> <span style=color:#111>numpy</span><span style=color:#f92672>.</span><span style=color:#111>array</span><span style=color:#111>(</span><span style=color:#111>zero_guess</span><span style=color:#111>,</span><span style=color:#111>dtype</span> <span style=color:#f92672>=</span> <span style=color:#111>numpy</span><span style=color:#f92672>.</span><span style=color:#111>float64</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#111>sum_of_squared_error</span> <span style=color:#f92672>=</span> <span style=color:#111>((</span><span style=color:#111>zero_guess_n</span><span style=color:#f92672>**</span><span style=color:#ae81ff>2</span><span style=color:#111>)</span><span style=color:#f92672>.</span><span style=color:#111>sum</span><span style=color:#111>())</span><span style=color:#f92672>**</span><span style=color:#ae81ff>.5</span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e># print(guess,sum_of_squared_error)</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#111>sum_of_squared_error</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>fun</span>
</span></span></code></pre></div><p>Let&rsquo;s also make a function for plotting.</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>plot_fourbar</span><span style=color:#111>(</span><span style=color:#111>design</span><span style=color:#111>,</span><span style=color:#111>independent</span><span style=color:#111>,</span><span style=color:#111>dependent</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#111>points_n</span> <span style=color:#f92672>=</span> <span style=color:#111>points</span><span style=color:#f92672>.</span><span style=color:#111>subs</span><span style=color:#111>({</span><span style=color:#f92672>**</span><span style=color:#111>design</span><span style=color:#111>,</span><span style=color:#f92672>**</span><span style=color:#111>independent</span><span style=color:#111>,</span><span style=color:#f92672>**</span><span style=color:#111>dependent</span><span style=color:#111>})</span>
</span></span><span style=display:flex><span>    <span style=color:#111>points_n</span> <span style=color:#f92672>=</span> <span style=color:#111>numpy</span><span style=color:#f92672>.</span><span style=color:#111>array</span><span style=color:#111>(</span><span style=color:#111>points_n</span><span style=color:#111>,</span><span style=color:#111>dtype</span> <span style=color:#f92672>=</span> <span style=color:#111>numpy</span><span style=color:#f92672>.</span><span style=color:#111>float64</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>plt</span><span style=color:#f92672>.</span><span style=color:#111>plot</span><span style=color:#111>(</span><span style=color:#f92672>*</span><span style=color:#111>points_n</span><span style=color:#111>[:</span><span style=color:#ae81ff>2</span><span style=color:#111>])</span>
</span></span><span style=display:flex><span>    <span style=color:#111>plt</span><span style=color:#f92672>.</span><span style=color:#111>axis</span><span style=color:#111>(</span><span style=color:#d88200>&#39;equal&#39;</span><span style=color:#111>)</span>
</span></span></code></pre></div><p>Now, we can supply different points and plot them</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>ini</span> <span style=color:#f92672>=</span> <span style=color:#111>[</span><span style=color:#ae81ff>45</span><span style=color:#f92672>*</span><span style=color:#111>math</span><span style=color:#f92672>.</span><span style=color:#111>pi</span><span style=color:#f92672>/</span><span style=color:#ae81ff>180</span><span style=color:#111>,</span><span style=color:#f92672>-</span><span style=color:#ae81ff>45</span><span style=color:#f92672>*</span><span style=color:#111>math</span><span style=color:#f92672>.</span><span style=color:#111>pi</span><span style=color:#f92672>/</span><span style=color:#ae81ff>180</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>independent</span> <span style=color:#f92672>=</span> <span style=color:#111>{</span><span style=color:#111>qb</span><span style=color:#111>:</span><span style=color:#ae81ff>90</span><span style=color:#f92672>*</span><span style=color:#111>pi</span><span style=color:#f92672>/</span><span style=color:#ae81ff>180</span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>myfun</span> <span style=color:#f92672>=</span> <span style=color:#111>gen_fun</span><span style=color:#111>(</span><span style=color:#111>design</span><span style=color:#111>,</span><span style=color:#111>independent</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>res</span> <span style=color:#f92672>=</span> <span style=color:#111>so</span><span style=color:#f92672>.</span><span style=color:#111>minimize</span><span style=color:#111>(</span><span style=color:#111>myfun</span><span style=color:#111>,</span><span style=color:#111>ini</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>dependent</span> <span style=color:#f92672>=</span> <span style=color:#111>dict</span><span style=color:#111>(</span><span style=color:#111>zip</span><span style=color:#111>([</span><span style=color:#111>qc</span><span style=color:#111>,</span><span style=color:#111>qd</span><span style=color:#111>],</span><span style=color:#111>res</span><span style=color:#f92672>.</span><span style=color:#111>x</span><span style=color:#111>))</span>      
</span></span><span style=display:flex><span><span style=color:#111>plot_fourbar</span><span style=color:#111>(</span><span style=color:#111>design</span><span style=color:#111>,</span><span style=color:#111>independent</span><span style=color:#111>,</span><span style=color:#111>dependent</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>independent</span> <span style=color:#f92672>=</span> <span style=color:#111>{</span><span style=color:#111>qb</span><span style=color:#111>:</span><span style=color:#ae81ff>80</span><span style=color:#f92672>*</span><span style=color:#111>pi</span><span style=color:#f92672>/</span><span style=color:#ae81ff>180</span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>myfun</span> <span style=color:#f92672>=</span> <span style=color:#111>gen_fun</span><span style=color:#111>(</span><span style=color:#111>design</span><span style=color:#111>,</span><span style=color:#111>independent</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>res</span> <span style=color:#f92672>=</span> <span style=color:#111>so</span><span style=color:#f92672>.</span><span style=color:#111>minimize</span><span style=color:#111>(</span><span style=color:#111>myfun</span><span style=color:#111>,</span><span style=color:#111>ini</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>dependent</span> <span style=color:#f92672>=</span> <span style=color:#111>dict</span><span style=color:#111>(</span><span style=color:#111>zip</span><span style=color:#111>([</span><span style=color:#111>qc</span><span style=color:#111>,</span><span style=color:#111>qd</span><span style=color:#111>],</span><span style=color:#111>res</span><span style=color:#f92672>.</span><span style=color:#111>x</span><span style=color:#111>))</span>      
</span></span><span style=display:flex><span><span style=color:#111>plot_fourbar</span><span style=color:#111>(</span><span style=color:#111>design</span><span style=color:#111>,</span><span style=color:#111>independent</span><span style=color:#111>,</span><span style=color:#111>dependent</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>independent</span> <span style=color:#f92672>=</span> <span style=color:#111>{</span><span style=color:#111>qb</span><span style=color:#111>:</span><span style=color:#ae81ff>70</span><span style=color:#f92672>*</span><span style=color:#111>pi</span><span style=color:#f92672>/</span><span style=color:#ae81ff>180</span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>myfun</span> <span style=color:#f92672>=</span> <span style=color:#111>gen_fun</span><span style=color:#111>(</span><span style=color:#111>design</span><span style=color:#111>,</span><span style=color:#111>independent</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>res</span> <span style=color:#f92672>=</span> <span style=color:#111>so</span><span style=color:#f92672>.</span><span style=color:#111>minimize</span><span style=color:#111>(</span><span style=color:#111>myfun</span><span style=color:#111>,</span><span style=color:#111>ini</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>dependent</span> <span style=color:#f92672>=</span> <span style=color:#111>dict</span><span style=color:#111>(</span><span style=color:#111>zip</span><span style=color:#111>([</span><span style=color:#111>qc</span><span style=color:#111>,</span><span style=color:#111>qd</span><span style=color:#111>],</span><span style=color:#111>res</span><span style=color:#f92672>.</span><span style=color:#111>x</span><span style=color:#111>))</span>      
</span></span><span style=display:flex><span><span style=color:#111>plot_fourbar</span><span style=color:#111>(</span><span style=color:#111>design</span><span style=color:#111>,</span><span style=color:#111>independent</span><span style=color:#111>,</span><span style=color:#111>dependent</span><span style=color:#111>)</span>
</span></span></code></pre></div><figure><img src=/work-blog/2024-03-13-sympy-fourbar/output_51_0.png></figure><p>The problem is that the solver can sometimes fail, or converge to an unexpected answer This can be for a couple reasons.</p><ol><li>You supplied a bad initial guess</li><li>There is no solution given the combination of design parameters and independent parameters you selected.</li></ol><p>For example:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>ini</span> <span style=color:#f92672>=</span> <span style=color:#111>[</span><span style=color:#ae81ff>45</span><span style=color:#f92672>*</span><span style=color:#111>math</span><span style=color:#f92672>.</span><span style=color:#111>pi</span><span style=color:#f92672>/</span><span style=color:#ae81ff>180</span><span style=color:#111>,</span><span style=color:#f92672>-</span><span style=color:#ae81ff>45</span><span style=color:#f92672>*</span><span style=color:#111>math</span><span style=color:#f92672>.</span><span style=color:#111>pi</span><span style=color:#f92672>/</span><span style=color:#ae81ff>180</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span><span style=color:#111>design</span> <span style=color:#f92672>=</span> <span style=color:#111>{</span><span style=color:#111>qa</span><span style=color:#111>:</span><span style=color:#ae81ff>0</span><span style=color:#111>,</span><span style=color:#111>la</span><span style=color:#111>:</span><span style=color:#ae81ff>2</span><span style=color:#111>,</span><span style=color:#111>lb</span><span style=color:#111>:</span><span style=color:#ae81ff>1</span><span style=color:#111>,</span><span style=color:#111>lc</span><span style=color:#111>:</span><span style=color:#ae81ff>1</span><span style=color:#111>,</span><span style=color:#111>ld</span><span style=color:#111>:</span><span style=color:#ae81ff>1</span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>independent</span> <span style=color:#f92672>=</span> <span style=color:#111>{</span><span style=color:#111>qb</span><span style=color:#111>:</span><span style=color:#ae81ff>70</span><span style=color:#f92672>*</span><span style=color:#111>pi</span><span style=color:#f92672>/</span><span style=color:#ae81ff>180</span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>myfun</span> <span style=color:#f92672>=</span> <span style=color:#111>gen_fun</span><span style=color:#111>(</span><span style=color:#111>design</span><span style=color:#111>,</span><span style=color:#111>independent</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>res</span> <span style=color:#f92672>=</span> <span style=color:#111>so</span><span style=color:#f92672>.</span><span style=color:#111>minimize</span><span style=color:#111>(</span><span style=color:#111>myfun</span><span style=color:#111>,</span><span style=color:#111>ini</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>dependent</span> <span style=color:#f92672>=</span> <span style=color:#111>dict</span><span style=color:#111>(</span><span style=color:#111>zip</span><span style=color:#111>([</span><span style=color:#111>qc</span><span style=color:#111>,</span><span style=color:#111>qd</span><span style=color:#111>],</span><span style=color:#111>res</span><span style=color:#f92672>.</span><span style=color:#111>x</span><span style=color:#111>))</span>      
</span></span><span style=display:flex><span><span style=color:#111>plot_fourbar</span><span style=color:#111>(</span><span style=color:#111>design</span><span style=color:#111>,</span><span style=color:#111>independent</span><span style=color:#111>,</span><span style=color:#111>dependent</span><span style=color:#111>)</span>
</span></span></code></pre></div><figure><img src=/work-blog/2024-03-13-sympy-fourbar/output_53_0.png></figure><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>ini</span> <span style=color:#f92672>=</span> <span style=color:#111>[</span><span style=color:#ae81ff>45</span><span style=color:#f92672>*</span><span style=color:#111>math</span><span style=color:#f92672>.</span><span style=color:#111>pi</span><span style=color:#f92672>/</span><span style=color:#ae81ff>180</span><span style=color:#111>,</span><span style=color:#ae81ff>90</span><span style=color:#f92672>*</span><span style=color:#111>math</span><span style=color:#f92672>.</span><span style=color:#111>pi</span><span style=color:#f92672>/</span><span style=color:#ae81ff>180</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span><span style=color:#111>design</span> <span style=color:#f92672>=</span> <span style=color:#111>{</span><span style=color:#111>qa</span><span style=color:#111>:</span><span style=color:#ae81ff>0</span><span style=color:#111>,</span><span style=color:#111>la</span><span style=color:#111>:</span><span style=color:#ae81ff>1</span><span style=color:#111>,</span><span style=color:#111>lb</span><span style=color:#111>:</span><span style=color:#ae81ff>2</span><span style=color:#111>,</span><span style=color:#111>lc</span><span style=color:#111>:</span><span style=color:#ae81ff>2</span><span style=color:#111>,</span><span style=color:#111>ld</span><span style=color:#111>:</span><span style=color:#ae81ff>1</span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>independent</span> <span style=color:#f92672>=</span> <span style=color:#111>{</span><span style=color:#111>qb</span><span style=color:#111>:</span><span style=color:#ae81ff>120</span><span style=color:#f92672>*</span><span style=color:#111>pi</span><span style=color:#f92672>/</span><span style=color:#ae81ff>180</span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>myfun</span> <span style=color:#f92672>=</span> <span style=color:#111>gen_fun</span><span style=color:#111>(</span><span style=color:#111>design</span><span style=color:#111>,</span><span style=color:#111>independent</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>res</span> <span style=color:#f92672>=</span> <span style=color:#111>so</span><span style=color:#f92672>.</span><span style=color:#111>minimize</span><span style=color:#111>(</span><span style=color:#111>myfun</span><span style=color:#111>,</span><span style=color:#111>ini</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>dependent</span> <span style=color:#f92672>=</span> <span style=color:#111>dict</span><span style=color:#111>(</span><span style=color:#111>zip</span><span style=color:#111>([</span><span style=color:#111>qc</span><span style=color:#111>,</span><span style=color:#111>qd</span><span style=color:#111>],</span><span style=color:#111>res</span><span style=color:#f92672>.</span><span style=color:#111>x</span><span style=color:#111>))</span>      
</span></span><span style=display:flex><span><span style=color:#111>plot_fourbar</span><span style=color:#111>(</span><span style=color:#111>design</span><span style=color:#111>,</span><span style=color:#111>independent</span><span style=color:#111>,</span><span style=color:#111>dependent</span><span style=color:#111>)</span>
</span></span></code></pre></div><figure><img src=/work-blog/2024-03-13-sympy-fourbar/output_54_0.png></figure><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>ini</span> <span style=color:#f92672>=</span> <span style=color:#111>[</span><span style=color:#ae81ff>10</span><span style=color:#f92672>*</span><span style=color:#111>math</span><span style=color:#f92672>.</span><span style=color:#111>pi</span><span style=color:#f92672>/</span><span style=color:#ae81ff>180</span><span style=color:#111>,</span><span style=color:#ae81ff>60</span><span style=color:#f92672>*</span><span style=color:#111>math</span><span style=color:#f92672>.</span><span style=color:#111>pi</span><span style=color:#f92672>/</span><span style=color:#ae81ff>180</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span><span style=color:#111>design</span> <span style=color:#f92672>=</span> <span style=color:#111>{</span><span style=color:#111>qa</span><span style=color:#111>:</span><span style=color:#ae81ff>10</span><span style=color:#f92672>*</span><span style=color:#111>pi</span><span style=color:#f92672>/</span><span style=color:#ae81ff>180</span><span style=color:#111>,</span><span style=color:#111>la</span><span style=color:#111>:</span><span style=color:#ae81ff>1</span><span style=color:#111>,</span><span style=color:#111>lb</span><span style=color:#111>:</span><span style=color:#ae81ff>2</span><span style=color:#111>,</span><span style=color:#111>lc</span><span style=color:#111>:</span><span style=color:#ae81ff>1</span><span style=color:#111>,</span><span style=color:#111>ld</span><span style=color:#111>:</span><span style=color:#ae81ff>2</span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>independent</span> <span style=color:#f92672>=</span> <span style=color:#111>{</span><span style=color:#111>qb</span><span style=color:#111>:</span><span style=color:#ae81ff>60</span><span style=color:#f92672>*</span><span style=color:#111>pi</span><span style=color:#f92672>/</span><span style=color:#ae81ff>180</span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>myfun</span> <span style=color:#f92672>=</span> <span style=color:#111>gen_fun</span><span style=color:#111>(</span><span style=color:#111>design</span><span style=color:#111>,</span><span style=color:#111>independent</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>res</span> <span style=color:#f92672>=</span> <span style=color:#111>so</span><span style=color:#f92672>.</span><span style=color:#111>minimize</span><span style=color:#111>(</span><span style=color:#111>myfun</span><span style=color:#111>,</span><span style=color:#111>ini</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>dependent</span> <span style=color:#f92672>=</span> <span style=color:#111>dict</span><span style=color:#111>(</span><span style=color:#111>zip</span><span style=color:#111>([</span><span style=color:#111>qc</span><span style=color:#111>,</span><span style=color:#111>qd</span><span style=color:#111>],</span><span style=color:#111>res</span><span style=color:#f92672>.</span><span style=color:#111>x</span><span style=color:#111>))</span>      
</span></span><span style=display:flex><span><span style=color:#111>plot_fourbar</span><span style=color:#111>(</span><span style=color:#111>design</span><span style=color:#111>,</span><span style=color:#111>independent</span><span style=color:#111>,</span><span style=color:#111>dependent</span><span style=color:#111>)</span>
</span></span></code></pre></div><figure><img src=/work-blog/2024-03-13-sympy-fourbar/output_55_0.png></figure><h3 id=symbolic-solving>Symbolic Solving</h3><p>So how can we solve the symbolic expressions directly? Well we can use <code>sympy.solve()</code>. For example, we can take a specific design in a specific state, and solve for the remaining variables:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>design</span> <span style=color:#f92672>=</span> <span style=color:#111>{</span><span style=color:#111>qa</span><span style=color:#111>:</span><span style=color:#ae81ff>0</span><span style=color:#111>,</span><span style=color:#111>la</span><span style=color:#111>:</span><span style=color:#ae81ff>1.2</span><span style=color:#111>,</span><span style=color:#111>lb</span><span style=color:#111>:</span><span style=color:#ae81ff>.9</span><span style=color:#111>,</span><span style=color:#111>lc</span><span style=color:#111>:</span><span style=color:#ae81ff>1.1</span><span style=color:#111>,</span><span style=color:#111>ld</span><span style=color:#111>:</span><span style=color:#ae81ff>1.1</span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>independent</span> <span style=color:#f92672>=</span> <span style=color:#111>{</span><span style=color:#111>qb</span><span style=color:#111>:</span><span style=color:#ae81ff>30</span><span style=color:#f92672>*</span><span style=color:#111>pi</span><span style=color:#f92672>/</span><span style=color:#ae81ff>180</span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>zero_specific</span> <span style=color:#f92672>=</span> <span style=color:#111>zero</span><span style=color:#f92672>.</span><span style=color:#111>subs</span><span style=color:#111>({</span><span style=color:#f92672>**</span><span style=color:#111>design</span><span style=color:#111>,</span><span style=color:#f92672>**</span><span style=color:#111>independent</span><span style=color:#111>})</span>
</span></span><span style=display:flex><span><span style=color:#111>zero_specific</span>
</span></span></code></pre></div><p>$\displaystyle \left[\begin{matrix}- 1.1 \sin{\left(\theta_{c} \right)} \sin{\left(\theta_{d} \right)} + 1.1 \cos{\left(\theta_{c} \right)} \cos{\left(\theta_{d} \right)} + 1.1 \cos{\left(\theta_{c} \right)} - 1.97942286340599\\1.1 \sin{\left(\theta_{c} \right)} \cos{\left(\theta_{d} \right)} + 1.1 \sin{\left(\theta_{c} \right)} + 1.1 \sin{\left(\theta_{d} \right)} \cos{\left(\theta_{c} \right)} - 0.45\end{matrix}\right]$</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>sol</span> <span style=color:#f92672>=</span> <span style=color:#111>sympy</span><span style=color:#f92672>.</span><span style=color:#111>solve</span><span style=color:#111>(</span><span style=color:#111>zero_specific</span><span style=color:#111>,(</span><span style=color:#111>qc</span><span style=color:#111>,</span><span style=color:#111>qd</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span><span style=color:#111>sol</span>
</span></span></code></pre></div><pre><code>[(-0.172242420242400, 0.791564062543542),
 (0.619321642301143, -0.791564062543542)]
</code></pre><p>The solver was successfully able to identify the two potential solutions to the trigonometric problem:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>dependent</span> <span style=color:#f92672>=</span> <span style=color:#111>dict</span><span style=color:#111>(</span><span style=color:#111>zip</span><span style=color:#111>([</span><span style=color:#111>qc</span><span style=color:#111>,</span><span style=color:#111>qd</span><span style=color:#111>],</span><span style=color:#111>sol</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>]))</span>      
</span></span><span style=display:flex><span><span style=color:#111>plt</span><span style=color:#f92672>.</span><span style=color:#111>figure</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#111>plot_fourbar</span><span style=color:#111>(</span><span style=color:#111>design</span><span style=color:#111>,</span><span style=color:#111>independent</span><span style=color:#111>,</span><span style=color:#111>dependent</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>dependent</span> <span style=color:#f92672>=</span> <span style=color:#111>dict</span><span style=color:#111>(</span><span style=color:#111>zip</span><span style=color:#111>([</span><span style=color:#111>qc</span><span style=color:#111>,</span><span style=color:#111>qd</span><span style=color:#111>],</span><span style=color:#111>sol</span><span style=color:#111>[</span><span style=color:#ae81ff>1</span><span style=color:#111>]))</span>      
</span></span><span style=display:flex><span><span style=color:#111>plt</span><span style=color:#f92672>.</span><span style=color:#111>figure</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#111>plot_fourbar</span><span style=color:#111>(</span><span style=color:#111>design</span><span style=color:#111>,</span><span style=color:#111>independent</span><span style=color:#111>,</span><span style=color:#111>dependent</span><span style=color:#111>)</span>
</span></span></code></pre></div><figure><img src=/work-blog/2024-03-13-sympy-fourbar/output_60_0.png></figure><figure><img src=/work-blog/2024-03-13-sympy-fourbar/output_60_1.png></figure><p>But we had already substituted all the other symbolic variables with numeric answers. What if we wanted to solve the generic problem as a function of qb?</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>design</span> <span style=color:#f92672>=</span> <span style=color:#111>{</span><span style=color:#111>qa</span><span style=color:#111>:</span><span style=color:#ae81ff>0</span><span style=color:#111>,</span><span style=color:#111>la</span><span style=color:#111>:</span><span style=color:#ae81ff>1.2</span><span style=color:#111>,</span><span style=color:#111>lb</span><span style=color:#111>:</span><span style=color:#ae81ff>.9</span><span style=color:#111>,</span><span style=color:#111>lc</span><span style=color:#111>:</span><span style=color:#ae81ff>1.1</span><span style=color:#111>,</span><span style=color:#111>ld</span><span style=color:#111>:</span><span style=color:#ae81ff>1.1</span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e># zero = sympy.Matrix((p4-p2)[:2])</span>
</span></span><span style=display:flex><span><span style=color:#111>zero_specific</span> <span style=color:#f92672>=</span> <span style=color:#111>zero</span><span style=color:#f92672>.</span><span style=color:#111>subs</span><span style=color:#111>(</span><span style=color:#111>design</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>zero_specific</span>
</span></span></code></pre></div><p>$\displaystyle \left[\begin{matrix}- 1.1 \sin{\left(\theta_{c} \right)} \sin{\left(\theta_{d} \right)} - 0.9 \cos{\left(\theta_{b} \right)} + 1.1 \cos{\left(\theta_{c} \right)} \cos{\left(\theta_{d} \right)} + 1.1 \cos{\left(\theta_{c} \right)} - 1.2\\- 0.9 \sin{\left(\theta_{b} \right)} + 1.1 \sin{\left(\theta_{c} \right)} \cos{\left(\theta_{d} \right)} + 1.1 \sin{\left(\theta_{c} \right)} + 1.1 \sin{\left(\theta_{d} \right)} \cos{\left(\theta_{c} \right)}\end{matrix}\right]$</p><p>In this case we supplied all the design variables but did not include the independent parameter. The expressions don&rsquo;t look too hard&mldr;should we try solving?</p><p>NO!</p><p>Unfortunately, sympy is not able to solve this expression as a function of the independent variable in a reasonable time. This is both due to sympy&rsquo;s limitations, and due to the fact that the nested trigonometric functions hide quite a bit of complexity. So don&rsquo;t run the code below:
generic_solution = sympy.solve(zero_specific,(qc,qd))
So now let&rsquo;s try to simplify the expression by hand a little bit. First thing to recognize is that the coupler of our four-bar (link D) can be removed from the expression. Instead of saying that $\vec{p}_4-\vec{p}_2=0$, we could also say that $$|\vec{p}_3 - \vec{p}_2|=l_d$$
This permits us to remove $q_d$ entirely from the set of equations, simplifying our expression to
$$(\vec{p}_3 - \vec{p}_2)\cdot (\vec{p}_3 - \vec{p}_2) = l_d$$
in sympy,</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>coupler</span> <span style=color:#f92672>=</span> <span style=color:#111>p3</span><span style=color:#f92672>-</span><span style=color:#111>p2</span>
</span></span><span style=display:flex><span><span style=color:#111>zero2</span> <span style=color:#f92672>=</span> <span style=color:#111>(</span><span style=color:#111>coupler</span><span style=color:#f92672>.</span><span style=color:#111>T</span><span style=color:#f92672>*</span><span style=color:#111>coupler</span><span style=color:#111>)[</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span><span style=color:#f92672>-</span><span style=color:#111>ld</span><span style=color:#f92672>**</span><span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span><span style=color:#111>zero2</span>
</span></span><span style=display:flex><span><span style=color:#111>zero_specific</span> <span style=color:#f92672>=</span> <span style=color:#111>zero2</span><span style=color:#f92672>.</span><span style=color:#111>subs</span><span style=color:#111>(</span><span style=color:#111>design</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>zero_specific</span>
</span></span></code></pre></div><p>$\displaystyle 1.21 \left(- 0.818181818181818 \sin{\left(\theta_{b} \right)} + \sin{\left(\theta_{c} \right)}\right)^{2} + 1.44 \left(- 0.75 \cos{\left(\theta_{b} \right)} + 0.916666666666667 \cos{\left(\theta_{c} \right)} - 1\right)^{2} - 1.21$</p><p>Not too bad&mldr;but again, the squares hide some complexity. What does it look like when we expand this expression?</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>zero_specific</span> <span style=color:#f92672>=</span> <span style=color:#111>zero_specific</span><span style=color:#f92672>.</span><span style=color:#111>expand</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#111>zero_specific</span>
</span></span></code></pre></div><p>$\displaystyle 0.81 \sin^{2}{\left(\theta_{b} \right)} - 1.98 \sin{\left(\theta_{b} \right)} \sin{\left(\theta_{c} \right)} + 1.21 \sin^{2}{\left(\theta_{c} \right)} + 0.81 \cos^{2}{\left(\theta_{b} \right)} - 1.98 \cos{\left(\theta_{b} \right)} \cos{\left(\theta_{c} \right)} + 2.16 \cos{\left(\theta_{b} \right)} + 1.21 \cos^{2}{\left(\theta_{c} \right)} - 2.64 \cos{\left(\theta_{c} \right)} + 0.23$</p><p>Oof, getting longer. Let&rsquo;s use the simplify expression to try to identify ways of eliminating redundancies, using trig identities to shorten the expression, etc.</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>zero_specific</span> <span style=color:#f92672>=</span> <span style=color:#111>zero_specific</span><span style=color:#f92672>.</span><span style=color:#111>simplify</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#111>zero_specific</span>
</span></span></code></pre></div><p>$\displaystyle 2.16 \cos{\left(\theta_{b} \right)} - 2.64 \cos{\left(\theta_{c} \right)} - 1.98 \cos{\left(\theta_{b} - \theta_{c} \right)} + 2.25$</p><p>Now it&rsquo;s much shorter, but is it short enough for sympy to solve with respect to $\theta_b$? Unfortunately no. Don&rsquo;t run the next command:
generic_solution = sympy.solve(zero_specific,(qc))</p><h3 id=general-solution>General Solution</h3><p>Okay, so how to do this, while capturing all the variables of the design? We have to help sympy. First, let&rsquo;s only supply the definition for $\theta_a$ to our zero2 variable:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>zero_specific</span> <span style=color:#f92672>=</span> <span style=color:#111>zero2</span><span style=color:#f92672>.</span><span style=color:#111>subs</span><span style=color:#111>({</span><span style=color:#111>qa</span><span style=color:#111>:</span><span style=color:#ae81ff>0</span><span style=color:#111>})</span>
</span></span><span style=display:flex><span><span style=color:#111>zero_specific</span>
</span></span></code></pre></div><p>$\displaystyle - l_{d}^{2} + \left(- l_{b} \sin{\left(\theta_{b} \right)} + l_{c} \sin{\left(\theta_{c} \right)}\right)^{2} + \left(- l_{a} - l_{b} \cos{\left(\theta_{b} \right)} + l_{c} \cos{\left(\theta_{c} \right)}\right)^{2}$</p><p>Let&rsquo;s expand to see how bad it is&mldr;</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>zero_specific</span> <span style=color:#f92672>=</span> <span style=color:#111>zero_specific</span><span style=color:#f92672>.</span><span style=color:#111>expand</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#111>zero_specific</span>
</span></span></code></pre></div><p>$\displaystyle l_{a}^{2} + 2 l_{a} l_{b} \cos{\left(\theta_{b} \right)} - 2 l_{a} l_{c} \cos{\left(\theta_{c} \right)} + l_{b}^{2} \sin^{2}{\left(\theta_{b} \right)} + l_{b}^{2} \cos^{2}{\left(\theta_{b} \right)} - 2 l_{b} l_{c} \sin{\left(\theta_{b} \right)} \sin{\left(\theta_{c} \right)} - 2 l_{b} l_{c} \cos{\left(\theta_{b} \right)} \cos{\left(\theta_{c} \right)} + l_{c}^{2} \sin^{2}{\left(\theta_{c} \right)} + l_{c}^{2} \cos^{2}{\left(\theta_{c} \right)} - l_{d}^{2}$</p><p>Ouch. Let&rsquo;s simplify:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>z2</span> <span style=color:#f92672>=</span> <span style=color:#111>zero_specific</span><span style=color:#f92672>.</span><span style=color:#111>simplify</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#111>z2</span>
</span></span></code></pre></div><p>$\displaystyle l_{a}^{2} + 2 l_{a} l_{b} \cos{\left(\theta_{b} \right)} - 2 l_{a} l_{c} \cos{\left(\theta_{c} \right)} + l_{b}^{2} - 2 l_{b} l_{c} \cos{\left(\theta_{b} - \theta_{c} \right)} + l_{c}^{2} - l_{d}^{2}$</p><p>Better. This helped find $\sin^2(x) + \cos^2(x) = 1$ identities and eliminate them, as well as shorten trig expressions where possible. But our simplify did too much condensing, bringing $\theta_b$ and $\theta_c$ within a $cos()$ term. For our solver, this makes things harder again. Let&rsquo;s expand back out:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>z3</span><span style=color:#f92672>=</span><span style=color:#111>sympy</span><span style=color:#f92672>.</span><span style=color:#111>expand_trig</span><span style=color:#111>(</span><span style=color:#111>z2</span><span style=color:#111>)</span><span style=color:#f92672>.</span><span style=color:#111>expand</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#111>z3</span>
</span></span></code></pre></div><p>$\displaystyle l_{a}^{2} + 2 l_{a} l_{b} \cos{\left(\theta_{b} \right)} - 2 l_{a} l_{c} \cos{\left(\theta_{c} \right)} + l_{b}^{2} - 2 l_{b} l_{c} \sin{\left(\theta_{b} \right)} \sin{\left(\theta_{c} \right)} - 2 l_{b} l_{c} \cos{\left(\theta_{b} \right)} \cos{\left(\theta_{c} \right)} + l_{c}^{2} - l_{d}^{2}$</p><p>Now the tricky part. We see in this expanded form that $\theta_c$ comes either in the form of $\sin(\theta_c)$ and $\cos(\theta_c)$ terms. lets collect our expression around terms that contain those, or not.</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>d</span> <span style=color:#f92672>=</span> <span style=color:#111>z3</span><span style=color:#f92672>.</span><span style=color:#111>collect</span><span style=color:#111>((</span><span style=color:#111>sin</span><span style=color:#111>(</span><span style=color:#111>qc</span><span style=color:#111>),</span><span style=color:#111>cos</span><span style=color:#111>(</span><span style=color:#111>qc</span><span style=color:#111>)),</span><span style=color:#111>evaluate</span><span style=color:#f92672>=</span><span style=color:#00a8c8>False</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>for</span> <span style=color:#111>key</span> <span style=color:#f92672>in</span> <span style=color:#111>d</span><span style=color:#f92672>.</span><span style=color:#111>keys</span><span style=color:#111>():</span>
</span></span><span style=display:flex><span>    <span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>key</span><span style=color:#111>,</span><span style=color:#d88200>&#39;: &#39;</span><span style=color:#111>,</span><span style=color:#111>d</span><span style=color:#111>[</span><span style=color:#111>key</span><span style=color:#111>])</span>
</span></span></code></pre></div><pre><code>cos(\theta_c) :  -2*l_a*l_c - 2*l_b*l_c*cos(\theta_b)
sin(\theta_c) :  -2*l_b*l_c*sin(\theta_b)
1 :  l_a**2 + 2*l_a*l_b*cos(\theta_b) + l_b**2 + l_c**2 - l_d**2
</code></pre><p>Using some advanced features of the collect function, we see that all the terms of the expression are either multiplied by $\sin(\theta_c)$ and $\cos(\theta_c)$ or $1$. Since we are trying to solve for $\theta_c$, let&rsquo;s substitute in simpler expressions for those coefficients.</p><p>First we create 3 new symbols, for the 3 sets of coefficients we are replacing</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>symbol_strings</span> <span style=color:#f92672>=</span> <span style=color:#111>[</span><span style=color:#d88200>&#39;s_</span><span style=color:#d88200>{}</span><span style=color:#d88200>&#39;</span><span style=color:#f92672>.</span><span style=color:#111>format</span><span style=color:#111>(</span><span style=color:#111>ii</span><span style=color:#111>)</span> <span style=color:#00a8c8>for</span> <span style=color:#111>ii</span> <span style=color:#f92672>in</span> <span style=color:#111>range</span><span style=color:#111>(</span><span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#111>d</span><span style=color:#111>))]</span>
</span></span><span style=display:flex><span><span style=color:#111>symbol_strings</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;,&#39;</span><span style=color:#f92672>.</span><span style=color:#111>join</span><span style=color:#111>(</span><span style=color:#111>symbol_strings</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>symbols</span> <span style=color:#f92672>=</span> <span style=color:#111>sympy</span><span style=color:#f92672>.</span><span style=color:#111>symbols</span><span style=color:#111>(</span><span style=color:#111>symbol_strings</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>symbols</span>
</span></span></code></pre></div><pre><code>(s_0, s_1, s_2)
</code></pre><p>We then create two new dictionaries. z4_subs1 is going to hold our replacement symbols for the three coefficients</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>keys</span> <span style=color:#f92672>=</span> <span style=color:#111>d</span><span style=color:#f92672>.</span><span style=color:#111>keys</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#111>z4_subs1</span> <span style=color:#f92672>=</span> <span style=color:#111>dict</span><span style=color:#111>(</span><span style=color:#111>zip</span><span style=color:#111>(</span><span style=color:#111>keys</span><span style=color:#111>,</span><span style=color:#111>symbols</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span><span style=color:#111>z4_subs1</span>
</span></span></code></pre></div><pre><code>{cos(\theta_c): s_0, sin(\theta_c): s_1, 1: s_2}
</code></pre><p>The second dictionary will replace the symbols with the original coefficients, once we have solved.</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>z4_subs2</span> <span style=color:#f92672>=</span> <span style=color:#111>dict</span><span style=color:#111>(</span><span style=color:#111>zip</span><span style=color:#111>(</span><span style=color:#111>symbols</span><span style=color:#111>,[</span><span style=color:#111>d</span><span style=color:#111>[</span><span style=color:#111>item</span><span style=color:#111>]</span> <span style=color:#00a8c8>for</span> <span style=color:#111>item</span> <span style=color:#f92672>in</span> <span style=color:#111>keys</span><span style=color:#111>]))</span>
</span></span><span style=display:flex><span><span style=color:#111>z4_subs2</span>
</span></span></code></pre></div><pre><code>{s_0: -2*l_a*l_c - 2*l_b*l_c*cos(\theta_b),
 s_1: -2*l_b*l_c*sin(\theta_b),
 s_2: l_a**2 + 2*l_a*l_b*cos(\theta_b) + l_b**2 + l_c**2 - l_d**2}
</code></pre><p>We create expression z4, which is each key ($\sin(\theta_c)$, $\cos(\theta_c)$, $1$) times our new symbols</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>z4</span> <span style=color:#f92672>=</span> <span style=color:#111>[</span><span style=color:#111>item</span><span style=color:#f92672>*</span><span style=color:#111>z4_subs1</span><span style=color:#111>[</span><span style=color:#111>item</span><span style=color:#111>]</span> <span style=color:#00a8c8>for</span> <span style=color:#111>item</span> <span style=color:#f92672>in</span> <span style=color:#111>keys</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span><span style=color:#111>z4</span> <span style=color:#f92672>=</span> <span style=color:#111>sum</span><span style=color:#111>(</span><span style=color:#111>z4</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>z4</span>
</span></span></code></pre></div><p>$\displaystyle s_{0} \cos{\left(\theta_{c} \right)} + s_{1} \sin{\left(\theta_{c} \right)} + s_{2}$</p><p>Aah, finally simple enough to solve</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>sol</span> <span style=color:#f92672>=</span> <span style=color:#111>sympy</span><span style=color:#f92672>.</span><span style=color:#111>solve</span><span style=color:#111>(</span><span style=color:#111>z4</span><span style=color:#111>,</span><span style=color:#111>qc</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>sol</span> <span style=color:#f92672>=</span> <span style=color:#111>sympy</span><span style=color:#f92672>.</span><span style=color:#111>Matrix</span><span style=color:#111>(</span><span style=color:#111>sol</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>sol</span>
</span></span></code></pre></div><p>$\displaystyle \left[\begin{matrix}2 \operatorname{atan}{\left(\frac{s_{1} - \sqrt{s_{0}^{2} + s_{1}^{2} - s_{2}^{2}}}{s_{0} - s_{2}} \right)}\\2 \operatorname{atan}{\left(\frac{s_{1} + \sqrt{s_{0}^{2} + s_{1}^{2} - s_{2}^{2}}}{s_{0} - s_{2}} \right)}\end{matrix}\right]$</p><p>We now replace <code>s_0</code>, <code>s_1</code>, and <code>s_2</code> with their original contents:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>sol</span> <span style=color:#f92672>=</span> <span style=color:#111>sol</span><span style=color:#f92672>.</span><span style=color:#111>subs</span><span style=color:#111>(</span><span style=color:#111>z4_subs2</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>sol</span>
</span></span></code></pre></div><p>$\displaystyle \left[\begin{matrix}2 \operatorname{atan}{\left(\frac{- 2 l_{b} l_{c} \sin{\left(\theta_{b} \right)} - \sqrt{4 l_{b}^{2} l_{c}^{2} \sin^{2}{\left(\theta_{b} \right)} + \left(- 2 l_{a} l_{c} - 2 l_{b} l_{c} \cos{\left(\theta_{b} \right)}\right)^{2} - \left(l_{a}^{2} + 2 l_{a} l_{b} \cos{\left(\theta_{b} \right)} + l_{b}^{2} + l_{c}^{2} - l_{d}^{2}\right)^{2}}}{- l_{a}^{2} - 2 l_{a} l_{b} \cos{\left(\theta_{b} \right)} - 2 l_{a} l_{c} - l_{b}^{2} - 2 l_{b} l_{c} \cos{\left(\theta_{b} \right)} - l_{c}^{2} + l_{d}^{2}} \right)}\\2 \operatorname{atan}{\left(\frac{- 2 l_{b} l_{c} \sin{\left(\theta_{b} \right)} + \sqrt{4 l_{b}^{2} l_{c}^{2} \sin^{2}{\left(\theta_{b} \right)} + \left(- 2 l_{a} l_{c} - 2 l_{b} l_{c} \cos{\left(\theta_{b} \right)}\right)^{2} - \left(l_{a}^{2} + 2 l_{a} l_{b} \cos{\left(\theta_{b} \right)} + l_{b}^{2} + l_{c}^{2} - l_{d}^{2}\right)^{2}}}{- l_{a}^{2} - 2 l_{a} l_{b} \cos{\left(\theta_{b} \right)} - 2 l_{a} l_{c} - l_{b}^{2} - 2 l_{b} l_{c} \cos{\left(\theta_{b} \right)} - l_{c}^{2} + l_{d}^{2}} \right)}\end{matrix}\right]$</p><p>This is finally a general solution to our coupler problem, but it takes a while to run the .subs() function within a loop. We can use the sympy.lambdify() function to turn this expression into a function, which is generally faster to evaluate. To do this we need to supply all the variables we need to replace in this expression to the lambdify function. We can use the atoms() function again to find them:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>variables</span> <span style=color:#f92672>=</span> <span style=color:#111>list</span><span style=color:#111>(</span><span style=color:#111>sol</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>atoms</span><span style=color:#111>(</span><span style=color:#111>sympy</span><span style=color:#f92672>.</span><span style=color:#111>Symbol</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span><span style=color:#111>variables</span>
</span></span></code></pre></div><pre><code>[\theta_b, l_c, l_d, l_b, l_a]
</code></pre><p>We then &ldquo;lambdify&rdquo; the solution:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>fc</span> <span style=color:#f92672>=</span> <span style=color:#111>sympy</span><span style=color:#f92672>.</span><span style=color:#111>lambdify</span><span style=color:#111>(</span><span style=color:#111>variables</span><span style=color:#111>,</span><span style=color:#111>sol</span><span style=color:#111>)</span>
</span></span></code></pre></div><p>And now we can use it with a given design and state</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>design</span> <span style=color:#f92672>=</span> <span style=color:#111>{</span><span style=color:#111>qa</span><span style=color:#111>:</span><span style=color:#ae81ff>0</span><span style=color:#111>,</span><span style=color:#111>la</span><span style=color:#111>:</span><span style=color:#ae81ff>1</span><span style=color:#111>,</span><span style=color:#111>lb</span><span style=color:#111>:</span><span style=color:#ae81ff>1</span><span style=color:#111>,</span><span style=color:#111>lc</span><span style=color:#111>:</span><span style=color:#ae81ff>1</span><span style=color:#111>,</span><span style=color:#111>ld</span><span style=color:#111>:</span><span style=color:#ae81ff>.7</span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>independent</span> <span style=color:#f92672>=</span> <span style=color:#111>{</span><span style=color:#111>qb</span><span style=color:#111>:</span><span style=color:#ae81ff>120</span><span style=color:#f92672>*</span><span style=color:#111>pi</span><span style=color:#f92672>/</span><span style=color:#ae81ff>180</span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>input</span> <span style=color:#f92672>=</span> <span style=color:#111>[{</span><span style=color:#f92672>**</span><span style=color:#111>design</span><span style=color:#111>,</span><span style=color:#f92672>**</span><span style=color:#111>independent</span><span style=color:#111>}[</span><span style=color:#111>item</span><span style=color:#111>]</span> <span style=color:#00a8c8>for</span> <span style=color:#111>item</span> <span style=color:#f92672>in</span> <span style=color:#111>variables</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span><span style=color:#111>sol_n</span> <span style=color:#f92672>=</span> <span style=color:#111>fc</span><span style=color:#111>(</span><span style=color:#f92672>*</span><span style=color:#111>input</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>sol_n</span>
</span></span></code></pre></div><pre><code>array([[1.76233976],
       [0.33205534]])
</code></pre><p>There are two solutions. Substituting in the first solution for the answer to our dependent variable (qc), we can plot it. Note that we plot the coupler in red as its position is <em>inferred</em> from our solution, but not explicitly solved for. If needed, this could be done in a later step</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>dependent</span> <span style=color:#f92672>=</span> <span style=color:#111>{</span><span style=color:#111>qc</span><span style=color:#111>:</span><span style=color:#111>sol_n</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>,</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>real</span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>dependent</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>points1</span> <span style=color:#f92672>=</span> <span style=color:#111>sympy</span><span style=color:#f92672>.</span><span style=color:#111>Matrix</span><span style=color:#111>([</span><span style=color:#111>p2</span><span style=color:#f92672>.</span><span style=color:#111>T</span><span style=color:#111>,</span><span style=color:#111>p1</span><span style=color:#f92672>.</span><span style=color:#111>T</span><span style=color:#111>,</span><span style=color:#111>o</span><span style=color:#f92672>.</span><span style=color:#111>T</span><span style=color:#111>,</span><span style=color:#111>p3</span><span style=color:#f92672>.</span><span style=color:#111>T</span><span style=color:#111>])</span><span style=color:#f92672>.</span><span style=color:#111>T</span>
</span></span><span style=display:flex><span><span style=color:#111>points2</span> <span style=color:#f92672>=</span> <span style=color:#111>sympy</span><span style=color:#f92672>.</span><span style=color:#111>Matrix</span><span style=color:#111>([</span><span style=color:#111>p2</span><span style=color:#f92672>.</span><span style=color:#111>T</span><span style=color:#111>,</span><span style=color:#111>p3</span><span style=color:#f92672>.</span><span style=color:#111>T</span><span style=color:#111>])</span><span style=color:#f92672>.</span><span style=color:#111>T</span>
</span></span><span style=display:flex><span><span style=color:#111>points1_n</span> <span style=color:#f92672>=</span> <span style=color:#111>points1</span><span style=color:#f92672>.</span><span style=color:#111>subs</span><span style=color:#111>({</span><span style=color:#f92672>**</span><span style=color:#111>design</span><span style=color:#111>,</span><span style=color:#f92672>**</span><span style=color:#111>independent</span><span style=color:#111>,</span><span style=color:#f92672>**</span><span style=color:#111>dependent</span><span style=color:#111>})</span>
</span></span><span style=display:flex><span><span style=color:#111>points2_n</span> <span style=color:#f92672>=</span> <span style=color:#111>points2</span><span style=color:#f92672>.</span><span style=color:#111>subs</span><span style=color:#111>({</span><span style=color:#f92672>**</span><span style=color:#111>design</span><span style=color:#111>,</span><span style=color:#f92672>**</span><span style=color:#111>independent</span><span style=color:#111>,</span><span style=color:#f92672>**</span><span style=color:#111>dependent</span><span style=color:#111>})</span>
</span></span><span style=display:flex><span><span style=color:#111>points1_n</span> <span style=color:#f92672>=</span> <span style=color:#111>numpy</span><span style=color:#f92672>.</span><span style=color:#111>array</span><span style=color:#111>(</span><span style=color:#111>points1_n</span><span style=color:#111>,</span><span style=color:#111>dtype</span> <span style=color:#f92672>=</span> <span style=color:#111>numpy</span><span style=color:#f92672>.</span><span style=color:#111>float64</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>points2_n</span> <span style=color:#f92672>=</span> <span style=color:#111>numpy</span><span style=color:#f92672>.</span><span style=color:#111>array</span><span style=color:#111>(</span><span style=color:#111>points2_n</span><span style=color:#111>,</span><span style=color:#111>dtype</span> <span style=color:#f92672>=</span> <span style=color:#111>numpy</span><span style=color:#f92672>.</span><span style=color:#111>float64</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>plt</span><span style=color:#f92672>.</span><span style=color:#111>plot</span><span style=color:#111>(</span><span style=color:#f92672>*</span><span style=color:#111>points1_n</span><span style=color:#111>[:</span><span style=color:#ae81ff>2</span><span style=color:#111>],</span><span style=color:#d88200>&#39;b&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>plt</span><span style=color:#f92672>.</span><span style=color:#111>plot</span><span style=color:#111>(</span><span style=color:#f92672>*</span><span style=color:#111>points2_n</span><span style=color:#111>[:</span><span style=color:#ae81ff>2</span><span style=color:#111>],</span><span style=color:#d88200>&#39;r&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>plt</span><span style=color:#f92672>.</span><span style=color:#111>axis</span><span style=color:#111>(</span><span style=color:#d88200>&#39;equal&#39;</span><span style=color:#111>)</span>
</span></span></code></pre></div><pre><code>(-0.24989304217985683,
 1.059518716294279,
 -0.04908557873865836,
 1.0307971535118254)
</code></pre><figure><img src=/work-blog/2024-03-13-sympy-fourbar/output_102_1.png></figure><p>We can visualize the second solution as well:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>dependent</span> <span style=color:#f92672>=</span> <span style=color:#111>{</span><span style=color:#111>qc</span><span style=color:#111>:</span><span style=color:#111>sol_n</span><span style=color:#111>[</span><span style=color:#ae81ff>1</span><span style=color:#111>,</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>real</span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>dependent</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>points1</span> <span style=color:#f92672>=</span> <span style=color:#111>sympy</span><span style=color:#f92672>.</span><span style=color:#111>Matrix</span><span style=color:#111>([</span><span style=color:#111>p2</span><span style=color:#f92672>.</span><span style=color:#111>T</span><span style=color:#111>,</span><span style=color:#111>p1</span><span style=color:#f92672>.</span><span style=color:#111>T</span><span style=color:#111>,</span><span style=color:#111>o</span><span style=color:#f92672>.</span><span style=color:#111>T</span><span style=color:#111>,</span><span style=color:#111>p3</span><span style=color:#f92672>.</span><span style=color:#111>T</span><span style=color:#111>])</span><span style=color:#f92672>.</span><span style=color:#111>T</span>
</span></span><span style=display:flex><span><span style=color:#111>points2</span> <span style=color:#f92672>=</span> <span style=color:#111>sympy</span><span style=color:#f92672>.</span><span style=color:#111>Matrix</span><span style=color:#111>([</span><span style=color:#111>p2</span><span style=color:#f92672>.</span><span style=color:#111>T</span><span style=color:#111>,</span><span style=color:#111>p3</span><span style=color:#f92672>.</span><span style=color:#111>T</span><span style=color:#111>])</span><span style=color:#f92672>.</span><span style=color:#111>T</span>
</span></span><span style=display:flex><span><span style=color:#111>points1_n</span> <span style=color:#f92672>=</span> <span style=color:#111>points1</span><span style=color:#f92672>.</span><span style=color:#111>subs</span><span style=color:#111>({</span><span style=color:#f92672>**</span><span style=color:#111>design</span><span style=color:#111>,</span><span style=color:#f92672>**</span><span style=color:#111>independent</span><span style=color:#111>,</span><span style=color:#f92672>**</span><span style=color:#111>dependent</span><span style=color:#111>})</span>
</span></span><span style=display:flex><span><span style=color:#111>points2_n</span> <span style=color:#f92672>=</span> <span style=color:#111>points2</span><span style=color:#f92672>.</span><span style=color:#111>subs</span><span style=color:#111>({</span><span style=color:#f92672>**</span><span style=color:#111>design</span><span style=color:#111>,</span><span style=color:#f92672>**</span><span style=color:#111>independent</span><span style=color:#111>,</span><span style=color:#f92672>**</span><span style=color:#111>dependent</span><span style=color:#111>})</span>
</span></span><span style=display:flex><span><span style=color:#111>points1_n</span> <span style=color:#f92672>=</span> <span style=color:#111>numpy</span><span style=color:#f92672>.</span><span style=color:#111>array</span><span style=color:#111>(</span><span style=color:#111>points1_n</span><span style=color:#111>,</span><span style=color:#111>dtype</span> <span style=color:#f92672>=</span> <span style=color:#111>numpy</span><span style=color:#f92672>.</span><span style=color:#111>float64</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>points2_n</span> <span style=color:#f92672>=</span> <span style=color:#111>numpy</span><span style=color:#f92672>.</span><span style=color:#111>array</span><span style=color:#111>(</span><span style=color:#111>points2_n</span><span style=color:#111>,</span><span style=color:#111>dtype</span> <span style=color:#f92672>=</span> <span style=color:#111>numpy</span><span style=color:#f92672>.</span><span style=color:#111>float64</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>plt</span><span style=color:#f92672>.</span><span style=color:#111>plot</span><span style=color:#111>(</span><span style=color:#f92672>*</span><span style=color:#111>points1_n</span><span style=color:#111>[:</span><span style=color:#ae81ff>2</span><span style=color:#111>],</span><span style=color:#d88200>&#39;b&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>plt</span><span style=color:#f92672>.</span><span style=color:#111>plot</span><span style=color:#111>(</span><span style=color:#f92672>*</span><span style=color:#111>points2_n</span><span style=color:#111>[:</span><span style=color:#ae81ff>2</span><span style=color:#111>],</span><span style=color:#d88200>&#39;r&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>plt</span><span style=color:#f92672>.</span><span style=color:#111>axis</span><span style=color:#111>(</span><span style=color:#d88200>&#39;equal&#39;</span><span style=color:#111>)</span>
</span></span></code></pre></div><pre><code>(-0.05, 1.05, -0.043301270189221946, 0.9093266739736607)
</code></pre><figure><img src=/work-blog/2024-03-13-sympy-fourbar/output_104_1.png></figure></div></div></div></div></section><footer class=text-capitalize><div class=container><div class="row justify-content-center"><div class="col-12 border-top py-4 text-center"></div><div class="col-lg-4 col-sm-6 mb-5 text-center"><h6 class=mb-4>Contact Me</h6><ul class=list-unstyled><li class=mb-3><i class="ti-location-pin mr-3 text-primary"></i>Arizona, USA</li></li></ul></div><div class="col-lg-4 col-sm-6 mb-5 text-center"><h6 class=mb-4>External</h6><ul class=list-unstyled><li class=mb-3><a class=text-dark href=https://github.com/danb0b>personal github</a></li><li class=mb-3><a class=text-dark href=https://www.linkedin.com/in/dan-aukes-502995212/>linkedin</a></li></ul></div><div class="col-lg-4 col-sm-6 mb-5 text-center"><h6 class=mb-4>Quick Links</h6><ul class=list-unstyled><li class=mb-3><a class=text-dark href=https://www.danaukes.com/about/>About</a></li><li class=mb-3><a class=text-dark href=https://idealab-asu.slack.com>IDEAlab Slack</a></li><li class=mb-3><a class=text-dark href=https://www.danaukes.com/contact/>Contact</a></li><li class=mb-3><a class=text-dark href=https://scram-workspace.slack.com>SCRAMbots</a></li><li class=mb-3><a class=text-dark href=https://www.danaukes.com/calendar/>Calendar</a></li><li class=mb-3><a class=text-dark href=https://kaiteki-asu.slack.com>Kaiteki</a></li></ul></div><div class="col-12 mb-5 text-center"><a href=https://www.danaukes.com/><img src=https://www.danaukes.com/da-small.png alt="Dan Aukes"></a></div><div class="col-12 mb-5 text-center"><p>| copyright  2023 Daniel Aukes. All Rights Reserved. |</p><p><a href=https://github.com/danb0b/danb0b.github.io/edit/master/content/work-blog/2024-03-13-sympy-fourbar/index.md>Edit this Page</a></p></div></div></div></footer><script>var indexURL="https://www.danaukes.com/index.json"</script><script src=https://www.danaukes.com/plugins/glightbox/js/glightbox.js></script><script src=https://www.danaukes.com/plugins/jQuery/jquery.min.js></script><script src=https://www.danaukes.com/plugins/bootstrap/bootstrap.min.js></script><script src=https://www.danaukes.com/plugins/slick/slick.min.js></script><script src=https://www.danaukes.com/plugins/venobox/venobox.min.js></script><script src=https://www.danaukes.com/plugins/search/fuse.min.js></script><script src=https://www.danaukes.com/plugins/search/mark.js></script><script src=https://www.danaukes.com/plugins/search/search.js></script><script src=https://www.danaukes.com/js/script.min.js></script><script>var lightboxDescription,lightboxVideo,lightboxInlineIframe,lightbox=GLightbox();lightbox.on("open",e=>{console.log("lightbox opened")}),lightboxDescription=GLightbox({selector:".glightbox2"}),lightboxVideo=GLightbox({selector:".glightbox3"}),lightboxVideo.on("slide_changed",({prev:e,current:t})=>{console.log("Prev slide",e),console.log("Current slide",t);const{slideIndex:s,slideNode:o,slideConfig:i,player:n}=t;n&&(n.ready||n.on("ready",e=>{}),n.on("play",e=>{console.log("Started play")}),n.on("volumechange",e=>{console.log("Volume change")}),n.on("ended",e=>{console.log("Video ended")}))}),lightboxInlineIframe=GLightbox({selector:".glightbox4"})</script></body></html>