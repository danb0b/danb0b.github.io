<!doctype html><html lang=en-us><head><meta charset=utf-8><title>Micro Servo Data Collection, Parameter Identification, and Modeling: Parts 5 and 6 | Dan Aukes </title><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=description content="Dan Aukes' personal website"><meta name=author content="Dan Aukes"><meta name=generator content="Hugo 0.126.1"><link rel=stylesheet href=https://www.danaukes.com/plugins/glightbox/css/glightbox.css><link rel=stylesheet href=https://www.danaukes.com/plugins/bootstrap/bootstrap.min.css><link rel=stylesheet href=https://www.danaukes.com/plugins/slick/slick.css><link rel=stylesheet href=https://www.danaukes.com/plugins/themify-icons/themify-icons.css><link rel=stylesheet href=https://www.danaukes.com/plugins/venobox/venobox.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css><link rel=stylesheet href=https://www.danaukes.com/scss/style.min.css media=screen><link rel="shortcut icon" href=https://www.danaukes.com/images/favicon.png type=image/x-icon><link rel=icon href=https://www.danaukes.com/images/favicon.png type=image/x-icon><script>(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)})(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","","auto"),ga("send","pageview")</script><script>MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]],processEscapes:!0,processEnvironments:!0},options:{skipHtmlTags:["script","noscript","style","textarea","pre"]}},window.addEventListener("load",e=>{document.querySelectorAll("mjx-container").forEach(function(e){e.parentElement.classList+="has-jax"})})</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script></head><body><div class=preloader></div><header class=navigation><div class=container><nav class="navbar navbar-expand-lg navbar-white bg-transparent border-bottom pl-0"><a class="navbar-brand mobile-view" href=https://www.danaukes.com/><img class=img-fluid src=https://www.danaukes.com/da-small.png alt="Dan Aukes"></a>
<button class="navbar-toggler border-0" type=button data-toggle=collapse data-target=#navigation>
<i class=ti-menu></i></button><div class="collapse navbar-collapse text-center" id=navigation><div class=desktop-view><ul class="navbar-nav mr-auto"><li class=nav-item><a class=nav-link href=https://github.com/danb0b><i class=ti-github></i></a></li><li class=nav-item><a class=nav-link href=https://www.linkedin.com/in/dan-aukes-502995212/><i class=ti-linkedin></i></a></li></ul></div><a class="navbar-brand mx-auto desktop-view" href=https://www.danaukes.com/><img class=img-fluid src=https://www.danaukes.com/da-small.png alt="Dan Aukes"></a><ul class=navbar-nav><li class=nav-item><a class=nav-link href=https://www.danaukes.com/work-blog/>Work Blog</a></li><li class=nav-item><a class=nav-link href=https://www.danaukes.com/notebook/>Notebook</a></li><li class=nav-item><a class=nav-link href=https://www.danaukes.com/travel/>Travel</a></li><li class=nav-item><a class=nav-link href=https://www.danaukes.com/recipes/>Recipes</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>Misc</a><div class=dropdown-menu><a class=dropdown-item href=https://www.danaukes.com/code/>Code</a>
<a class=dropdown-item href=https://www.danaukes.com/websites/>Websites</a>
<a class=dropdown-item href=https://www.danaukes.com/bookmarks/>Bookmarks</a></div></li></ul><form action=https://www.danaukes.com//search class=d-flex><input class="form-control me-2" id=search-query name=s type=s placeholder=Search aria-label=Search>
<button class="btn btn-outline-success" type=submit><i class="ti-search text-dark"></i></button></form></div></nav></div></header><section class=section-sm><div class=container><div class=row><div class="col-lg-8 mx-auto"><div class=text-center><nav aria-label=breadcrumb><ol class=breadcrumb><li class=breadcrumb-item><a href=https://www.danaukes.com/>Welcome</a></li><li class=breadcrumb-item><a href=https://www.danaukes.com/work-blog/>Work Blog</a></li><li class="breadcrumb-item active"><a href=https://www.danaukes.com/work-blog/2023-12-07-servo-fitting/>Micro Servo Data Collection, Parameter Identification, and Modeling: Parts 5 and 6</a></li></ol></nav></div><h2>Micro Servo Data Collection, Parameter Identification, and Modeling: Parts 5 and 6</h2><div class="mb-1 post-meta"><span>By Dan Aukes</span></div><ul class=list-inline></ul><div class="content mb-5"><video controls width=100% loop autoplay muted src=servo-fitting.mp4>
This browser does not support the video tag.</video><h2 id=introduction>Introduction</h2><p>In the last article I took some data from a small, off-the-shelf servo, the SG90, 9 gram micro-servo. In this article, I continue with modeling and parameter fitting. This work was done to prepare for the class I developed, called <em>Flexible Robotics</em>. This is an undergraduate course with a focus on mechanism design and kinematics, experimentation, prototyping, parameter ID and design optimization. I introduced the python interface to MuJoCo as our tool of choice for modeling and simulation in the second half of the course, as it is both relativly easy to pick up and it motivates many interesting discussions about contact, compliance, and modeling decisions. So this article focuses on how to model the servo using MuJoCo.</p><h2 id=steps>Steps</h2><h3 id=part-5-mujoco-based-model>Part 5: MuJoCo-based model</h3><p>This step involves developing a MuJoCo model matching the experimental setup, and using it in conjunction with the collected data in identifying the remaining unknown parameters.</p><p>First we import required packages and modules</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>matplotlib.pyplot</span> <span style=color:#00a8c8>as</span> <span style=color:#111>plt</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>numpy</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>math</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>yaml</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>mujoco</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>numpy</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>mediapy</span> <span style=color:#00a8c8>as</span> <span style=color:#111>media</span>
</span></span></code></pre></div><p>Since this is a separate ipython notebook, I am repeating some of my previous work (shame!). I define a square-wave function for emulating the control signal sent to the pwm model.</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>square</span><span style=color:#111>(</span><span style=color:#111>t</span><span style=color:#111>,</span><span style=color:#111>A</span><span style=color:#111>,</span><span style=color:#111>f</span><span style=color:#111>,</span><span style=color:#111>w</span><span style=color:#111>,</span><span style=color:#111>b</span><span style=color:#111>,</span><span style=color:#111>t_0</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#111>y</span> <span style=color:#f92672>=</span> <span style=color:#111>(</span><span style=color:#111>t</span><span style=color:#f92672>-</span><span style=color:#111>t_0</span><span style=color:#111>)</span><span style=color:#f92672>*</span><span style=color:#111>f</span> 
</span></span><span style=display:flex><span>    <span style=color:#111>y</span> <span style=color:#f92672>=</span> <span style=color:#111>y</span><span style=color:#f92672>%</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#111>y</span> <span style=color:#f92672>=</span> <span style=color:#111>(</span><span style=color:#111>y</span><span style=color:#f92672>&lt;</span><span style=color:#111>w</span><span style=color:#111>)</span><span style=color:#f92672>*</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#111>y</span> <span style=color:#f92672>=</span> <span style=color:#111>A</span><span style=color:#f92672>*</span><span style=color:#111>y</span> <span style=color:#f92672>+</span><span style=color:#111>b</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>y</span>
</span></span></code></pre></div><h4 id=motor-modeling>Motor Modeling</h4><p>This is where there is some guesswork involved. I pored over a number of datasheets (linked below) to identify common parameters across many different manufacturers. I know that the SG90 may not share the same innards across manufacturers, and in the past I&rsquo;ve even confirmed how different these devices behave. But I was without an oscilloscope, current meter, etc.</p><p>Most of the performance data was taken at the SG90&rsquo;s nominal 6 volts. This is important for obtaining the correctly scaled motor constants. Manufacturers listed a range of stall torques, but many were around the 15 N-cm range (or .15 N-m). One data sheet actually identified the gear ratio from the SG90&rsquo;s gear train as 55.5. This means we can find the motor&rsquo;s stall torque, using $t_{motor} = \frac{t_{output}}{G}$. Additionally, many manufacturers listed the &ldquo;max&rdquo; current to be around 550, 600, or 650 mA. I took this to mean &ldquo;stall current&rdquo;, and used 600 mA. From here we can identify the motor&rsquo;s resistance with $V_{nom}/i_{stall}=R$.</p><p>With stall torque and stall current we can also identify the motor&rsquo;s $k_t$, or torque constant, using $k_t=\frac{t_{stall}}{i_{stall}}$. This number should be the same as the motor&rsquo;s back-emf constant, or $k_e$. The motor&rsquo;s speed constant, $k_v$, should be a little different, and can be determined by finding $k_v=\frac{V_{nom}}{\omega_{NL}}$, where $\omega_{NL}$ is the motor&rsquo;s no-load speed. In one data sheet I found the max speed of the servo to be .66 degrees per millisecond. Using this we can calculate the motor&rsquo;s no-load speed to be</p><p>$$w_{NL} = G \frac{.66\text{ deg}}{\text{ ms}}\frac{1000 \text{ms}}{\text{s}} \frac{\pi \text{ rad}}{180\text{ deg}}$$</p><p>These two numbers are different because $k_v$ also captures any internal mechanical losses experience by the motor, which can be lumped into a damping term $b = \frac{k_t i_{NL}}{\omega_{NL}}$, where $i_{NL}$ is the no-load current of the servo, which I assume is mostly consumed by the motor. The derivation for this is relatively straightforward, but I won&rsquo;t do it here. (I teach this in my class though).</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>Vnom</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>6</span>
</span></span><span style=display:flex><span><span style=color:#111>G</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>55.5</span>
</span></span><span style=display:flex><span><span style=color:#111>t_stall</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>15</span><span style=color:#f92672>/</span><span style=color:#ae81ff>100</span><span style=color:#f92672>/</span><span style=color:#111>G</span>
</span></span><span style=display:flex><span><span style=color:#111>i_stall</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>.6</span>
</span></span><span style=display:flex><span><span style=color:#111>R</span> <span style=color:#f92672>=</span> <span style=color:#111>Vnom</span><span style=color:#f92672>/</span><span style=color:#111>i_stall</span>
</span></span><span style=display:flex><span><span style=color:#111>i_nl</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>.2</span>
</span></span><span style=display:flex><span><span style=color:#111>w_nl</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>.66</span><span style=color:#f92672>*</span><span style=color:#ae81ff>1000</span><span style=color:#f92672>*</span><span style=color:#111>math</span><span style=color:#f92672>.</span><span style=color:#111>pi</span><span style=color:#f92672>/</span><span style=color:#ae81ff>180</span><span style=color:#f92672>*</span><span style=color:#111>G</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>kt</span> <span style=color:#f92672>=</span> <span style=color:#111>t_stall</span><span style=color:#f92672>/</span> <span style=color:#111>i_stall</span>
</span></span><span style=display:flex><span><span style=color:#75715e># kv= Vnom/w_nl</span>
</span></span><span style=display:flex><span><span style=color:#111>ke</span> <span style=color:#f92672>=</span> <span style=color:#111>kt</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>b</span> <span style=color:#f92672>=</span> <span style=color:#111>kt</span><span style=color:#f92672>*</span><span style=color:#111>i_nl</span><span style=color:#f92672>/</span><span style=color:#111>w_nl</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>ts</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1e-4</span>
</span></span></code></pre></div><p>I load the sanitized experimental data saved from the last article.</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#00a8c8>with</span> <span style=color:#111>open</span><span style=color:#111>(</span><span style=color:#d88200>&#39;servo_data_collection.yml&#39;</span><span style=color:#111>)</span> <span style=color:#00a8c8>as</span> <span style=color:#111>f</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>    <span style=color:#111>servo_data</span> <span style=color:#f92672>=</span> <span style=color:#111>yaml</span><span style=color:#f92672>.</span><span style=color:#111>load</span><span style=color:#111>(</span><span style=color:#111>f</span><span style=color:#111>,</span><span style=color:#111>Loader</span><span style=color:#f92672>=</span><span style=color:#111>yaml</span><span style=color:#f92672>.</span><span style=color:#111>Loader</span><span style=color:#111>)</span>        
</span></span></code></pre></div><p>I convert it to a numpy array and check the shape</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>t_data</span> <span style=color:#f92672>=</span> <span style=color:#111>numpy</span><span style=color:#f92672>.</span><span style=color:#111>array</span><span style=color:#111>(</span><span style=color:#111>servo_data</span><span style=color:#111>[</span><span style=color:#d88200>&#39;t&#39;</span><span style=color:#111>])</span>
</span></span><span style=display:flex><span><span style=color:#111>t_data</span><span style=color:#f92672>.</span><span style=color:#111>shape</span>
</span></span></code></pre></div><pre><code>(214,)
</code></pre><p>Next, I determine the timestep of the data. This obviously just comes from the video, but I want to ensure that my mujoco data is saved at the same rate or else I will have to interpolate, decimate, or otherwise match disparate-timed events.</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>dt_data</span> <span style=color:#f92672>=</span> <span style=color:#111>(</span><span style=color:#111>t_data</span><span style=color:#111>[</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>]</span><span style=color:#f92672>-</span><span style=color:#111>t_data</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>])</span><span style=color:#f92672>/</span><span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#111>t_data</span><span style=color:#111>)</span>
</span></span></code></pre></div><p>I convert the theta data to a compatible numpy array and check the shape. This will need to match mujoco&rsquo;s simulated data.</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>q_data</span> <span style=color:#f92672>=</span> <span style=color:#111>numpy</span><span style=color:#f92672>.</span><span style=color:#111>array</span><span style=color:#111>([</span><span style=color:#111>servo_data</span><span style=color:#111>[</span><span style=color:#d88200>&#39;theta_u&#39;</span><span style=color:#111>]])</span><span style=color:#f92672>.</span><span style=color:#111>T</span>
</span></span><span style=display:flex><span><span style=color:#111>q_data</span><span style=color:#f92672>.</span><span style=color:#111>shape</span>
</span></span></code></pre></div><pre><code>(214, 1)
</code></pre><p>I define the desired control signal (for plotting purposes). You will see I redefine this inside the controller function.</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>desired</span> <span style=color:#f92672>=</span> <span style=color:#111>square</span><span style=color:#111>(</span><span style=color:#111>t_data</span><span style=color:#111>,</span><span style=color:#111>A</span><span style=color:#f92672>=</span><span style=color:#111>servo_data</span><span style=color:#111>[</span><span style=color:#d88200>&#39;A&#39;</span><span style=color:#111>],</span><span style=color:#111>f</span> <span style=color:#f92672>=</span> <span style=color:#111>servo_data</span><span style=color:#111>[</span><span style=color:#d88200>&#39;f&#39;</span><span style=color:#111>],</span><span style=color:#111>w</span><span style=color:#f92672>=</span><span style=color:#111>servo_data</span><span style=color:#111>[</span><span style=color:#d88200>&#39;w&#39;</span><span style=color:#111>],</span><span style=color:#111>b</span><span style=color:#f92672>=</span><span style=color:#111>servo_data</span><span style=color:#111>[</span><span style=color:#d88200>&#39;b&#39;</span><span style=color:#111>],</span><span style=color:#111>t_0</span><span style=color:#f92672>=</span><span style=color:#111>servo_data</span><span style=color:#111>[</span><span style=color:#d88200>&#39;t_0&#39;</span><span style=color:#111>])</span>    
</span></span></code></pre></div><p>I define my xml template and format, supplying the time constant from above variables. This consists of the following decisions:</p><ul><li>I make my timestep a template variable so I can adjust it in python without modifying the text.</li><li>my body consists of a cylinder whose size and mass matches the battery&rsquo;s dimensions. It is centered around a revolute joint in the x axis.</li><li>There is no information given about the motor&rsquo;s own inertia, so I am going to ignore its effect and assume that the battery&rsquo;s inertia dominates the motion. In class, we talk about the magnification of inertia through gearheads, but we will ignore it here.</li><li>I added a small cylinder on one side just for visualizing the battery better.</li><li>I include one actuator of type motor, located at joint_1. This will be controlled using a controller callback function I define later.</li></ul><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>render_width</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>800</span>
</span></span><span style=display:flex><span><span style=color:#111>render_height</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>600</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>xml_template</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#d88200>&lt;mujoco&gt;
</span></span></span><span style=display:flex><span><span style=color:#d88200>    &lt;visual&gt;&lt;global offwidth=&#34;</span><span style=color:#d88200>{render_width}</span><span style=color:#d88200>&#34; offheight=&#34;</span><span style=color:#d88200>{render_height}</span><span style=color:#d88200>&#34; /&gt;&lt;/visual&gt;
</span></span></span><span style=display:flex><span><span style=color:#d88200>    &lt;option timestep=&#34;</span><span style=color:#d88200>{ts}</span><span style=color:#d88200>&#34;/&gt;
</span></span></span><span style=display:flex><span><span style=color:#d88200>    &lt;worldbody&gt;
</span></span></span><span style=display:flex><span><span style=color:#d88200>        &lt;light name=&#34;top&#34; pos=&#34;0 0 10&#34;/&gt;
</span></span></span><span style=display:flex><span><span style=color:#d88200>        &lt;body name=&#34;body_1&#34; pos=&#34;0 0 0&#34; axisangle=&#34;1 0 0 0&#34;&gt;
</span></span></span><span style=display:flex><span><span style=color:#d88200>            &lt;joint name=&#34;joint_1&#34; type=&#34;hinge&#34; axis=&#34;1 0 0&#34; pos=&#34;0 0 0&#34;/&gt;
</span></span></span><span style=display:flex><span><span style=color:#d88200>            &lt;geom type=&#34;cylinder&#34; size=&#34;.00725 .024&#34; pos=&#34;0 0 0&#34; rgba=&#34;0 1 1 1&#34; mass=&#34;.016&#34;/&gt;
</span></span></span><span style=display:flex><span><span style=color:#d88200>            &lt;geom type=&#34;cylinder&#34; size=&#34;.0025 .0025&#34; pos=&#34;0 0 .024&#34; rgba=&#34;0 1 1 1&#34; mass=&#34;0&#34;/&gt;
</span></span></span><span style=display:flex><span><span style=color:#d88200>        &lt;/body&gt;
</span></span></span><span style=display:flex><span><span style=color:#d88200>    &lt;/worldbody&gt;
</span></span></span><span style=display:flex><span><span style=color:#d88200>&lt;actuator&gt;
</span></span></span><span style=display:flex><span><span style=color:#d88200>    &lt;motor name=&#34;motor_1&#34; joint=&#34;joint_1&#34;/&gt;
</span></span></span><span style=display:flex><span><span style=color:#d88200>&lt;/actuator&gt;
</span></span></span><span style=display:flex><span><span style=color:#d88200>&lt;/mujoco&gt;
</span></span></span><span style=display:flex><span><span style=color:#d88200>&#34;&#34;&#34;</span>
</span></span></code></pre></div><p>I format my template with my one variable, <code>ts</code>, to create my xml string</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>xml</span> <span style=color:#f92672>=</span> <span style=color:#111>xml_template</span><span style=color:#f92672>.</span><span style=color:#111>format</span><span style=color:#111>(</span><span style=color:#111>ts</span> <span style=color:#f92672>=</span> <span style=color:#111>ts</span><span style=color:#111>,</span> <span style=color:#111>render_width</span> <span style=color:#f92672>=</span> <span style=color:#111>render_width</span><span style=color:#111>,</span> <span style=color:#111>render_height</span> <span style=color:#f92672>=</span> <span style=color:#111>render_width</span><span style=color:#111>)</span>
</span></span></code></pre></div><p>I create my model, data and renderer and a function that runs the model, changing the kp and b values as needed.</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>model</span> <span style=color:#f92672>=</span> <span style=color:#111>mujoco</span><span style=color:#f92672>.</span><span style=color:#111>MjModel</span><span style=color:#f92672>.</span><span style=color:#111>from_xml_string</span><span style=color:#111>(</span><span style=color:#111>xml</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>data</span> <span style=color:#f92672>=</span> <span style=color:#111>mujoco</span><span style=color:#f92672>.</span><span style=color:#111>MjData</span><span style=color:#111>(</span><span style=color:#111>model</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>renderer</span> <span style=color:#f92672>=</span> <span style=color:#111>mujoco</span><span style=color:#f92672>.</span><span style=color:#111>Renderer</span><span style=color:#111>(</span><span style=color:#111>model</span><span style=color:#111>,</span><span style=color:#111>width</span><span style=color:#f92672>=</span><span style=color:#111>render_width</span><span style=color:#111>,</span><span style=color:#111>height</span><span style=color:#f92672>=</span><span style=color:#111>render_height</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>duration</span> <span style=color:#f92672>=</span> <span style=color:#111>t_data</span><span style=color:#111>[</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>]</span>  <span style=color:#75715e># (seconds)</span>
</span></span><span style=display:flex><span><span style=color:#111>framerate</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>30</span>  <span style=color:#75715e># (Hz)</span>
</span></span><span style=display:flex><span><span style=color:#111>data_rate</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>/</span><span style=color:#111>dt_data</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>duration</span><span style=color:#111>,</span><span style=color:#111>data_rate</span><span style=color:#111>)</span>
</span></span></code></pre></div><pre><code>7.122644 30.04502260677355
</code></pre><p>I next create a function that generates a controller callback function and runs the simulation, returning the time vector and position vector for <code>joint_1</code>.</p><p>The controller function I define, applies proportional control to the error between where the servo is commanded and where it is, and then converts that voltage command into the torque applied to the simulation. It does the following things:</p><ol><li><p>extracts the current velocity and position of joint_1, as well as the current time.</p></li><li><p>computes the desired position as a function of the <code>square()</code> function defined earlier, which is parameterized to match the control signal assumed from the experiment.</p></li><li><p>computes the error between deisred and actual</p></li><li><p>applies a scaling value ($k_p$) to the error and saves it as the control signal V. $k_p$ is not known, and has to be supplied to my <code>run_sim()</code> function.</p></li><li><p>checks whether V is outside of the supply voltage range <code>V_supply</code> and throttles it if so. I am assuming that inside the servo there is an h-bridge of some sort, that can control the voltage across the motor leads within close to the <code>V_supply</code> range.</p><blockquote><p>I am using <code>V_supply=5</code> instead of $V_{nom}$ from the equations above because my experiment was run at 5V rather than the datasheet&rsquo;s assumed 6V.</p></blockquote></li><li><p>computes the torque as a function of the motor parameters determined earlier, along with a new value, $b_{act}$ that represents any additional losses not correctly identified earlier. The equation I use is</p><p>$$\tau = G\left(\frac{k_t\left(V-k_e G\omega\right)}{R} -b_{act}G\omega \right)$$</p><p>Again, the derivation is straightforward, but I will save it for another article.</p></li><li><p>sets the torque of <code>joint_1</code></p></li></ol><p>Please see the code comments for more details about the rest of the simulation</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>run_sim</span><span style=color:#111>(</span><span style=color:#111>kp</span><span style=color:#111>,</span><span style=color:#111>b_act</span><span style=color:#111>,</span><span style=color:#111>render</span><span style=color:#f92672>=</span><span style=color:#00a8c8>False</span><span style=color:#111>,</span><span style=color:#111>video_filename</span><span style=color:#f92672>=</span><span style=color:#00a8c8>None</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Define the V_supply used in the experiment</span>
</span></span><span style=display:flex><span>    <span style=color:#111>V_supply</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>def</span> <span style=color:#75af00>mycontroller1</span><span style=color:#111>(</span><span style=color:#111>model</span><span style=color:#111>,</span> <span style=color:#111>data</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>        <span style=color:#d88200>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#d88200>        This function computes the torque to be applied to joint 1 
</span></span></span><span style=display:flex><span><span style=color:#d88200>        as a function of the time-based commands sent to the servo, 
</span></span></span><span style=display:flex><span><span style=color:#d88200>        and its current position and velocity.
</span></span></span><span style=display:flex><span><span style=color:#d88200>        &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#111>w</span> <span style=color:#f92672>=</span> <span style=color:#111>data</span><span style=color:#f92672>.</span><span style=color:#111>qvel</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>        <span style=color:#111>actual</span> <span style=color:#f92672>=</span> <span style=color:#111>data</span><span style=color:#f92672>.</span><span style=color:#111>qpos</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>        <span style=color:#111>t</span> <span style=color:#f92672>=</span> <span style=color:#111>data</span><span style=color:#f92672>.</span><span style=color:#111>time</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>desired</span> <span style=color:#f92672>=</span> <span style=color:#111>square</span><span style=color:#111>(</span><span style=color:#111>t</span><span style=color:#111>,</span><span style=color:#111>A</span><span style=color:#f92672>=</span><span style=color:#111>servo_data</span><span style=color:#111>[</span><span style=color:#d88200>&#39;A&#39;</span><span style=color:#111>],</span><span style=color:#111>f</span> <span style=color:#f92672>=</span> <span style=color:#111>servo_data</span><span style=color:#111>[</span><span style=color:#d88200>&#39;f&#39;</span><span style=color:#111>],</span><span style=color:#111>w</span><span style=color:#f92672>=</span><span style=color:#111>servo_data</span><span style=color:#111>[</span><span style=color:#d88200>&#39;w&#39;</span><span style=color:#111>],</span><span style=color:#111>b</span><span style=color:#f92672>=</span><span style=color:#111>servo_data</span><span style=color:#111>[</span><span style=color:#d88200>&#39;b&#39;</span><span style=color:#111>],</span><span style=color:#111>t_0</span><span style=color:#f92672>=</span><span style=color:#111>servo_data</span><span style=color:#111>[</span><span style=color:#d88200>&#39;t_0&#39;</span><span style=color:#111>])</span>
</span></span><span style=display:flex><span>        <span style=color:#111>error</span> <span style=color:#f92672>=</span> <span style=color:#111>desired</span><span style=color:#f92672>-</span><span style=color:#111>actual</span>
</span></span><span style=display:flex><span>        <span style=color:#111>V</span> <span style=color:#f92672>=</span> <span style=color:#111>kp</span><span style=color:#f92672>*</span><span style=color:#111>error</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#111>V</span><span style=color:#f92672>&gt;</span><span style=color:#111>V_supply</span><span style=color:#111>:</span> <span style=color:#111>V</span><span style=color:#f92672>=</span><span style=color:#111>V_supply</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#111>V</span><span style=color:#f92672>&lt;-</span><span style=color:#111>V_supply</span><span style=color:#111>:</span> <span style=color:#111>V</span><span style=color:#f92672>=-</span><span style=color:#111>V_supply</span>
</span></span><span style=display:flex><span>        <span style=color:#111>torque</span> <span style=color:#f92672>=</span> <span style=color:#111>(</span><span style=color:#111>kt</span><span style=color:#f92672>*</span><span style=color:#111>(</span><span style=color:#111>V</span><span style=color:#f92672>-</span><span style=color:#111>(</span><span style=color:#111>ke</span><span style=color:#111>)</span><span style=color:#f92672>*</span><span style=color:#111>w</span><span style=color:#f92672>*</span><span style=color:#111>G</span><span style=color:#111>)</span><span style=color:#f92672>/</span><span style=color:#111>R</span><span style=color:#f92672>-</span><span style=color:#111>b_act</span><span style=color:#f92672>*</span><span style=color:#111>w</span><span style=color:#f92672>*</span><span style=color:#111>G</span><span style=color:#111>)</span><span style=color:#f92672>*</span><span style=color:#111>G</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>data</span><span style=color:#f92672>.</span><span style=color:#111>ctrl</span> <span style=color:#f92672>=</span> <span style=color:#111>[</span><span style=color:#111>torque</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>try</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>mujoco</span><span style=color:#f92672>.</span><span style=color:#111>set_mjcb_control</span><span style=color:#111>(</span><span style=color:#111>mycontroller1</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>q</span> <span style=color:#f92672>=</span> <span style=color:#111>[]</span>
</span></span><span style=display:flex><span>        <span style=color:#111>w</span> <span style=color:#f92672>=</span> <span style=color:#111>[]</span>
</span></span><span style=display:flex><span>        <span style=color:#111>t</span> <span style=color:#f92672>=</span> <span style=color:#111>[]</span>
</span></span><span style=display:flex><span>        <span style=color:#111>frames</span> <span style=color:#f92672>=</span> <span style=color:#111>[]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>mujoco</span><span style=color:#f92672>.</span><span style=color:#111>mj_resetData</span><span style=color:#111>(</span><span style=color:#111>model</span><span style=color:#111>,</span> <span style=color:#111>data</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>while</span> <span style=color:#111>data</span><span style=color:#f92672>.</span><span style=color:#111>time</span> <span style=color:#f92672>&lt;</span> <span style=color:#111>duration</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># print(data.time)</span>
</span></span><span style=display:flex><span>            <span style=color:#111>mujoco</span><span style=color:#f92672>.</span><span style=color:#111>mj_step</span><span style=color:#111>(</span><span style=color:#111>model</span><span style=color:#111>,</span> <span style=color:#111>data</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>if</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#111>frames</span><span style=color:#111>)</span> <span style=color:#f92672>&lt;</span> <span style=color:#111>data</span><span style=color:#f92672>.</span><span style=color:#111>time</span> <span style=color:#f92672>*</span> <span style=color:#111>framerate</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>                <span style=color:#111>renderer</span><span style=color:#f92672>.</span><span style=color:#111>update_scene</span><span style=color:#111>(</span><span style=color:#111>data</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>                <span style=color:#111>pixels</span> <span style=color:#f92672>=</span> <span style=color:#111>renderer</span><span style=color:#f92672>.</span><span style=color:#111>render</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>                <span style=color:#111>frames</span><span style=color:#f92672>.</span><span style=color:#111>append</span><span style=color:#111>(</span><span style=color:#111>pixels</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>if</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#111>t</span><span style=color:#111>)</span> <span style=color:#f92672>&lt;</span> <span style=color:#111>data</span><span style=color:#f92672>.</span><span style=color:#111>time</span> <span style=color:#f92672>*</span> <span style=color:#111>data_rate</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e># print(data.time)</span>
</span></span><span style=display:flex><span>                <span style=color:#111>q</span><span style=color:#f92672>.</span><span style=color:#111>append</span><span style=color:#111>(</span><span style=color:#111>data</span><span style=color:#f92672>.</span><span style=color:#111>qpos</span><span style=color:#f92672>.</span><span style=color:#111>copy</span><span style=color:#111>())</span>
</span></span><span style=display:flex><span>                <span style=color:#111>w</span><span style=color:#f92672>.</span><span style=color:#111>append</span><span style=color:#111>(</span><span style=color:#111>data</span><span style=color:#f92672>.</span><span style=color:#111>qvel</span><span style=color:#f92672>.</span><span style=color:#111>copy</span><span style=color:#111>())</span>
</span></span><span style=display:flex><span>                <span style=color:#111>t</span><span style=color:#f92672>.</span><span style=color:#111>append</span><span style=color:#111>(</span><span style=color:#111>data</span><span style=color:#f92672>.</span><span style=color:#111>time</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#111>render</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>            <span style=color:#111>media</span><span style=color:#f92672>.</span><span style=color:#111>show_video</span><span style=color:#111>(</span><span style=color:#111>frames</span><span style=color:#111>,</span> <span style=color:#111>fps</span><span style=color:#f92672>=</span><span style=color:#111>framerate</span><span style=color:#111>,</span><span style=color:#111>width</span><span style=color:#f92672>=</span><span style=color:#111>render_width</span><span style=color:#111>,</span><span style=color:#111>height</span> <span style=color:#f92672>=</span> <span style=color:#111>render_height</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>if</span> <span style=color:#111>video_filename</span> <span style=color:#f92672>is</span> <span style=color:#f92672>not</span> <span style=color:#00a8c8>None</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>                <span style=color:#111>media</span><span style=color:#f92672>.</span><span style=color:#111>write_video</span><span style=color:#111>(</span><span style=color:#111>video_filename</span><span style=color:#111>,</span><span style=color:#111>frames</span><span style=color:#111>,</span><span style=color:#111>fps</span><span style=color:#f92672>=</span><span style=color:#111>framerate</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#111>mujoco</span><span style=color:#f92672>.</span><span style=color:#111>set_mjcb_control</span><span style=color:#111>(</span><span style=color:#00a8c8>None</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>        <span style=color:#111>t</span> <span style=color:#f92672>=</span> <span style=color:#111>numpy</span><span style=color:#f92672>.</span><span style=color:#111>array</span><span style=color:#111>(</span><span style=color:#111>t</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#111>q</span> <span style=color:#f92672>=</span> <span style=color:#111>numpy</span><span style=color:#f92672>.</span><span style=color:#111>array</span><span style=color:#111>(</span><span style=color:#111>q</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#111>q</span> <span style=color:#f92672>=</span> <span style=color:#111>q</span><span style=color:#111>[:</span><span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#111>q_data</span><span style=color:#111>)]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>except</span> <span style=color:#75af00>Exception</span> <span style=color:#00a8c8>as</span> <span style=color:#111>ex</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>        <span style=color:#111>mujoco</span><span style=color:#f92672>.</span><span style=color:#111>set_mjcb_control</span><span style=color:#111>(</span><span style=color:#00a8c8>None</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>raise</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>t</span><span style=color:#111>,</span> <span style=color:#111>q</span>
</span></span></code></pre></div><p>Run the model and output the time / joint values</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>t</span><span style=color:#111>,</span><span style=color:#111>q</span> <span style=color:#f92672>=</span> <span style=color:#111>run_sim</span><span style=color:#111>(</span><span style=color:#111>kp</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>15</span><span style=color:#111>,</span><span style=color:#111>b_act</span> <span style=color:#f92672>=</span> <span style=color:#111>b</span><span style=color:#111>,</span><span style=color:#111>render</span><span style=color:#f92672>=</span><span style=color:#00a8c8>True</span><span style=color:#111>,</span><span style=color:#111>video_filename</span><span style=color:#f92672>=</span><span style=color:#d88200>&#39;output1.mp4&#39;</span><span style=color:#111>)</span>
</span></span></code></pre></div><table class=show_videos style=border-spacing:0><tr><td style=padding:1px><video controls width=800 height=600 style=object-fit:cover loop autoplay muted src=output1.mp4>
This browser does not support the video tag.</video></td></tr></table><p>Let&rsquo;s plot the results and compare to the actual behavior and the command input.</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>a2</span> <span style=color:#f92672>=</span> <span style=color:#111>plt</span><span style=color:#f92672>.</span><span style=color:#111>plot</span><span style=color:#111>(</span><span style=color:#111>t_data</span><span style=color:#111>,</span><span style=color:#111>desired</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>a3</span>  <span style=color:#f92672>=</span> <span style=color:#111>plt</span><span style=color:#f92672>.</span><span style=color:#111>plot</span><span style=color:#111>(</span><span style=color:#111>t_data</span><span style=color:#111>,</span><span style=color:#111>q_data</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>a1</span> <span style=color:#f92672>=</span> <span style=color:#111>plt</span><span style=color:#f92672>.</span><span style=color:#111>plot</span><span style=color:#111>(</span><span style=color:#111>t_data</span><span style=color:#111>,</span><span style=color:#111>q</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>plt</span><span style=color:#f92672>.</span><span style=color:#111>legend</span><span style=color:#111>(</span><span style=color:#111>a1</span><span style=color:#f92672>+</span><span style=color:#111>a2</span><span style=color:#f92672>+</span><span style=color:#111>a3</span><span style=color:#111>,[</span><span style=color:#d88200>&#39;sim&#39;</span><span style=color:#111>,</span><span style=color:#d88200>&#39;control&#39;</span><span style=color:#111>,</span><span style=color:#d88200>&#39;actual&#39;</span><span style=color:#111>])</span>
</span></span><span style=display:flex><span><span style=color:#111>plt</span><span style=color:#f92672>.</span><span style=color:#111>show</span><span style=color:#111>()</span>
</span></span></code></pre></div><figure><img src=/work-blog/2023-12-07-servo-fitting/output_27_0.png alt="Plot of model vs collected data vs input signal."><figcaption><p>Plot of model vs collected data vs input signal.</p></figcaption></figure><p>Whoa, my guess was pretty good!</p><h2 id=discussion>Discussion</h2><p>Now let&rsquo;s talk about why I am only varying $k_p$ and $b$ in my simulation.</p><p>I have made some close but imperfect guesses for $k_t$, $k_e$, and $R$, but let&rsquo;s assume that our value for $G$ is correct. This gear ratio means that our servo hits its maximum velocity pretty quickly. This is often thought of as the servo&rsquo;s &ldquo;slew rate&rdquo;. It is mostly a function of the gear ratio, the internal mechanical loss, back-emf constants, and driving voltage. Even if the guess for $k_e$ is too large, the internal damping lumped into $b$ can be increased to match what we see at the output. And just because we made a guess for $V_{supply}=5$, this will be wrong too, because the transistors driving the current across the motor&rsquo;s coils will have a small voltage drop. Each of these unknowns serves to change the slope of the line; so we just have to pick one free variable to lump all these unknowns into. For this exercise I pick b, setting everything else to my educated guesswork from the datasheets, as discussed above.</p><p>Now let&rsquo;s talk about $k_p$. Our servo is at its maximum speed throughout most of its motion, meaning that our controller is saturated. So where does $k_p$ play a role in the shape of our output? If you think about it, the controller is only unsaturated at the &ldquo;knee&rdquo; of the step function, near the corners, where the speed begins to finally drop as the error gets closer to zero. The magnitude of $k_p$ will thus only determine the sharpness of the corners of the step function.</p><p>Lets try a couple different values to see what I mean. Changing $k_p$ values results in a sharp or rounded transition near the corners of my actuator&rsquo;s step response.</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>t</span><span style=color:#111>,</span><span style=color:#111>q1</span> <span style=color:#f92672>=</span> <span style=color:#111>run_sim</span><span style=color:#111>(</span><span style=color:#111>kp</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span><span style=color:#111>,</span><span style=color:#111>b_act</span> <span style=color:#f92672>=</span> <span style=color:#111>b</span><span style=color:#111>,</span><span style=color:#111>render</span><span style=color:#f92672>=</span><span style=color:#00a8c8>False</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>t</span><span style=color:#111>,</span><span style=color:#111>q2</span> <span style=color:#f92672>=</span> <span style=color:#111>run_sim</span><span style=color:#111>(</span><span style=color:#111>kp</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span><span style=color:#111>,</span><span style=color:#111>b_act</span> <span style=color:#f92672>=</span> <span style=color:#111>b</span><span style=color:#111>,</span><span style=color:#111>render</span><span style=color:#f92672>=</span><span style=color:#00a8c8>False</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>t</span><span style=color:#111>,</span><span style=color:#111>q3</span> <span style=color:#f92672>=</span> <span style=color:#111>run_sim</span><span style=color:#111>(</span><span style=color:#111>kp</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>20</span><span style=color:#111>,</span><span style=color:#111>b_act</span> <span style=color:#f92672>=</span> <span style=color:#111>b</span><span style=color:#111>,</span><span style=color:#111>render</span><span style=color:#f92672>=</span><span style=color:#00a8c8>False</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>a1</span> <span style=color:#f92672>=</span> <span style=color:#111>plt</span><span style=color:#f92672>.</span><span style=color:#111>plot</span><span style=color:#111>(</span><span style=color:#111>t_data</span><span style=color:#111>,</span><span style=color:#111>q1</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>a2</span>  <span style=color:#f92672>=</span> <span style=color:#111>plt</span><span style=color:#f92672>.</span><span style=color:#111>plot</span><span style=color:#111>(</span><span style=color:#111>t_data</span><span style=color:#111>,</span><span style=color:#111>q2</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>a3</span> <span style=color:#f92672>=</span> <span style=color:#111>plt</span><span style=color:#f92672>.</span><span style=color:#111>plot</span><span style=color:#111>(</span><span style=color:#111>t_data</span><span style=color:#111>,</span><span style=color:#111>q3</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>plt</span><span style=color:#f92672>.</span><span style=color:#111>legend</span><span style=color:#111>(</span><span style=color:#111>a1</span><span style=color:#f92672>+</span><span style=color:#111>a2</span><span style=color:#f92672>+</span><span style=color:#111>a3</span><span style=color:#111>,[</span><span style=color:#d88200>&#39;$k_p=2$&#39;</span><span style=color:#111>,</span><span style=color:#d88200>&#39;$k_p=4$&#39;</span><span style=color:#111>,</span><span style=color:#d88200>&#39;$k_p=20$&#39;</span><span style=color:#111>])</span>
</span></span><span style=display:flex><span><span style=color:#111>plt</span><span style=color:#f92672>.</span><span style=color:#111>show</span><span style=color:#111>()</span>
</span></span></code></pre></div><figure><img src=/work-blog/2023-12-07-servo-fitting/output_29_0.png alt="Comparing different values of $k_p$"><figcaption><p>Comparing different values of $k_p$</p></figcaption></figure><p>Likewise, changing the damping value mostly impacts the slope.</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>t</span><span style=color:#111>,</span><span style=color:#111>q1</span> <span style=color:#f92672>=</span> <span style=color:#111>run_sim</span><span style=color:#111>(</span><span style=color:#111>kp</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>20</span><span style=color:#111>,</span><span style=color:#111>b_act</span> <span style=color:#f92672>=</span> <span style=color:#111>b</span><span style=color:#111>,</span><span style=color:#111>render</span><span style=color:#f92672>=</span><span style=color:#00a8c8>False</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>t</span><span style=color:#111>,</span><span style=color:#111>q2</span> <span style=color:#f92672>=</span> <span style=color:#111>run_sim</span><span style=color:#111>(</span><span style=color:#111>kp</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>20</span><span style=color:#111>,</span><span style=color:#111>b_act</span> <span style=color:#f92672>=</span> <span style=color:#111>b</span><span style=color:#f92672>*</span><span style=color:#ae81ff>3</span><span style=color:#111>,</span><span style=color:#111>render</span><span style=color:#f92672>=</span><span style=color:#00a8c8>False</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>t</span><span style=color:#111>,</span><span style=color:#111>q3</span> <span style=color:#f92672>=</span> <span style=color:#111>run_sim</span><span style=color:#111>(</span><span style=color:#111>kp</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>20</span><span style=color:#111>,</span><span style=color:#111>b_act</span> <span style=color:#f92672>=</span> <span style=color:#111>b</span><span style=color:#f92672>*</span><span style=color:#ae81ff>6</span><span style=color:#111>,</span><span style=color:#111>render</span><span style=color:#f92672>=</span><span style=color:#00a8c8>False</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>a1</span> <span style=color:#f92672>=</span> <span style=color:#111>plt</span><span style=color:#f92672>.</span><span style=color:#111>plot</span><span style=color:#111>(</span><span style=color:#111>t_data</span><span style=color:#111>,</span><span style=color:#111>q1</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>a2</span>  <span style=color:#f92672>=</span> <span style=color:#111>plt</span><span style=color:#f92672>.</span><span style=color:#111>plot</span><span style=color:#111>(</span><span style=color:#111>t_data</span><span style=color:#111>,</span><span style=color:#111>q2</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>a3</span> <span style=color:#f92672>=</span> <span style=color:#111>plt</span><span style=color:#f92672>.</span><span style=color:#111>plot</span><span style=color:#111>(</span><span style=color:#111>t_data</span><span style=color:#111>,</span><span style=color:#111>q3</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>plt</span><span style=color:#f92672>.</span><span style=color:#111>legend</span><span style=color:#111>(</span><span style=color:#111>a1</span><span style=color:#f92672>+</span><span style=color:#111>a2</span><span style=color:#f92672>+</span><span style=color:#111>a3</span><span style=color:#111>,[</span><span style=color:#d88200>&#39;$b=</span><span style=color:#d88200>{b:1.2e}</span><span style=color:#d88200>$&#39;</span><span style=color:#f92672>.</span><span style=color:#111>format</span><span style=color:#111>(</span><span style=color:#111>b</span><span style=color:#f92672>=</span><span style=color:#111>b</span><span style=color:#111>),</span><span style=color:#d88200>&#39;$b=</span><span style=color:#d88200>{b:1.2e}</span><span style=color:#d88200>$&#39;</span><span style=color:#f92672>.</span><span style=color:#111>format</span><span style=color:#111>(</span><span style=color:#111>b</span><span style=color:#f92672>=</span><span style=color:#111>b</span><span style=color:#f92672>*</span><span style=color:#ae81ff>3</span><span style=color:#111>),</span><span style=color:#d88200>&#39;$b=</span><span style=color:#d88200>{b:1.2e}</span><span style=color:#d88200>$&#39;</span><span style=color:#f92672>.</span><span style=color:#111>format</span><span style=color:#111>(</span><span style=color:#111>b</span><span style=color:#f92672>=</span><span style=color:#111>b</span><span style=color:#f92672>*</span><span style=color:#ae81ff>6</span><span style=color:#111>)])</span>
</span></span><span style=display:flex><span><span style=color:#111>plt</span><span style=color:#f92672>.</span><span style=color:#111>show</span><span style=color:#111>()</span>
</span></span></code></pre></div><figure><img src=/work-blog/2023-12-07-servo-fitting/output_31_0.png alt="Comparing different values of $b$"><figcaption><p>Comparing different values of $b$</p></figcaption></figure><h2 id=part-6-parameter-identification>Part 6: Parameter identification</h2><p>So let&rsquo;s find the best values for $k_p$ and $b$. I import scipy.optimize and define a function that will be called by the minimize function. It runs the simulation and compares the simulation data against the experimental data, finds the error, and returns the sum of squared error over time.</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>scipy.optimize</span> <span style=color:#00a8c8>as</span> <span style=color:#111>so</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>fun</span><span style=color:#111>(</span><span style=color:#111>vars</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#111>k</span><span style=color:#111>,</span><span style=color:#111>b</span> <span style=color:#f92672>=</span> <span style=color:#111>vars</span>
</span></span><span style=display:flex><span>    <span style=color:#111>t</span><span style=color:#111>,</span><span style=color:#111>q</span> <span style=color:#f92672>=</span> <span style=color:#111>run_sim</span><span style=color:#111>(</span><span style=color:#111>k</span><span style=color:#111>,</span><span style=color:#111>b</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#111>error</span> <span style=color:#f92672>=</span> <span style=color:#111>q</span><span style=color:#f92672>-</span><span style=color:#111>q_data</span>
</span></span><span style=display:flex><span>    <span style=color:#111>error</span> <span style=color:#f92672>=</span> <span style=color:#111>error</span><span style=color:#f92672>**</span><span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>    <span style=color:#111>error</span> <span style=color:#f92672>=</span> <span style=color:#111>error</span><span style=color:#f92672>.</span><span style=color:#111>sum</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>    <span style=color:#111>error</span> <span style=color:#f92672>=</span> <span style=color:#111>error</span><span style=color:#f92672>**</span><span style=color:#ae81ff>.5</span>
</span></span><span style=display:flex><span>    <span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>k</span><span style=color:#111>,</span><span style=color:#111>b</span><span style=color:#111>,</span><span style=color:#111>error</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>error</span>
</span></span></code></pre></div><p>test it with an initial guess. The error from my guess is ~1.46. Try other values, see what you can get!</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>ini</span> <span style=color:#f92672>=</span> <span style=color:#111>[</span><span style=color:#ae81ff>15</span><span style=color:#111>,</span><span style=color:#111>b</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span><span style=color:#111>fun</span><span style=color:#111>(</span><span style=color:#111>ini</span><span style=color:#111>)</span>
</span></span></code></pre></div><pre><code>15 1.4091678782734167e-06 1.458970807257259





1.458970807257259
</code></pre><p>I found many of the algorithms had trouble converging. I had to add bounds and play with the tolerances</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>results</span> <span style=color:#f92672>=</span> <span style=color:#111>so</span><span style=color:#f92672>.</span><span style=color:#111>minimize</span><span style=color:#111>(</span><span style=color:#111>fun</span><span style=color:#111>,</span><span style=color:#111>x0</span><span style=color:#f92672>=</span><span style=color:#111>ini</span><span style=color:#111>,</span><span style=color:#111>method</span><span style=color:#f92672>=</span><span style=color:#d88200>&#39;nelder-mead&#39;</span><span style=color:#111>,</span><span style=color:#111>bounds</span> <span style=color:#f92672>=</span> <span style=color:#111>((</span><span style=color:#ae81ff>1</span><span style=color:#111>,</span><span style=color:#ae81ff>100</span><span style=color:#111>),(</span><span style=color:#111>b</span><span style=color:#f92672>*</span><span style=color:#ae81ff>.1</span><span style=color:#111>,</span><span style=color:#111>b</span><span style=color:#f92672>*</span><span style=color:#ae81ff>10</span><span style=color:#111>)),</span><span style=color:#111>options</span><span style=color:#f92672>=</span><span style=color:#111>{</span><span style=color:#d88200>&#39;xatol&#39;</span><span style=color:#111>:</span><span style=color:#ae81ff>1e-2</span><span style=color:#111>,</span><span style=color:#d88200>&#39;fatol&#39;</span><span style=color:#111>:</span><span style=color:#ae81ff>1e-2</span><span style=color:#111>})</span>
</span></span></code></pre></div><pre><code>15.0 1.4091678782734167e-06 1.458970807257259
15.75 1.4091678782734167e-06 1.462402830106116
15.0 1.4796262721870876e-06 1.4584701719279918
14.25 1.4796262721870876e-06 1.4562260034240078
13.5 1.514855469143923e-06 1.47061259159179
... ... ...
8.896713022899348 1.4041787991974594e-06 1.435694270256341
</code></pre><p>Check the final error. Better than when I started!</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>results</span><span style=color:#111>)</span>
</span></span></code></pre></div><pre><code>       message: Optimization terminated successfully.
       success: True
        status: 0
           fun: 1.435694270256341
             x: [ 8.897e+00  1.404e-06]
           nit: 30
          nfev: 53
 final_simplex: (array([[ 8.897e+00,  1.404e-06],
                       [ 8.892e+00,  1.404e-06],
                       [ 8.890e+00,  1.404e-06]]), array([ 1.436e+00,  1.436e+00,  1.436e+00]))
</code></pre><p>Now run my simulation with the results of the optimization</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>t</span><span style=color:#111>,</span><span style=color:#111>q</span> <span style=color:#f92672>=</span> <span style=color:#111>run_sim</span><span style=color:#111>(</span><span style=color:#f92672>*</span><span style=color:#111>results</span><span style=color:#f92672>.</span><span style=color:#111>x</span><span style=color:#111>,</span><span style=color:#111>render</span><span style=color:#f92672>=</span><span style=color:#00a8c8>True</span><span style=color:#111>,</span><span style=color:#111>video_filename</span><span style=color:#f92672>=</span><span style=color:#d88200>&#39;output.mp4&#39;</span><span style=color:#111>)</span>
</span></span></code></pre></div><table class=show_videos style=border-spacing:0><tr><td style=padding:1px><video controls width=800 height=600 style=object-fit:cover loop autoplay muted src=output.mp4>
This browser does not support the video tag.</video></td></tr></table><p>Plot the results</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>a2</span> <span style=color:#f92672>=</span> <span style=color:#111>plt</span><span style=color:#f92672>.</span><span style=color:#111>plot</span><span style=color:#111>(</span><span style=color:#111>t_data</span><span style=color:#111>,</span><span style=color:#111>desired</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>a3</span>  <span style=color:#f92672>=</span> <span style=color:#111>plt</span><span style=color:#f92672>.</span><span style=color:#111>plot</span><span style=color:#111>(</span><span style=color:#111>t_data</span><span style=color:#111>,</span><span style=color:#111>q_data</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>a1</span> <span style=color:#f92672>=</span> <span style=color:#111>plt</span><span style=color:#f92672>.</span><span style=color:#111>plot</span><span style=color:#111>(</span><span style=color:#111>t_data</span><span style=color:#111>,</span><span style=color:#111>q</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>plt</span><span style=color:#f92672>.</span><span style=color:#111>legend</span><span style=color:#111>(</span><span style=color:#111>a1</span><span style=color:#f92672>+</span><span style=color:#111>a2</span><span style=color:#f92672>+</span><span style=color:#111>a3</span><span style=color:#111>,[</span><span style=color:#d88200>&#39;sim&#39;</span><span style=color:#111>,</span><span style=color:#d88200>&#39;control&#39;</span><span style=color:#111>,</span><span style=color:#d88200>&#39;actual&#39;</span><span style=color:#111>])</span>
</span></span><span style=display:flex><span><span style=color:#111>plt</span><span style=color:#f92672>.</span><span style=color:#111>show</span><span style=color:#111>()</span>
</span></span></code></pre></div><figure><img src=/work-blog/2023-12-07-servo-fitting/output_43_0.png alt="Comparing model fit vs experimental data and input signal."><figcaption><p>Comparing model fit vs experimental data and input signal.</p></figcaption></figure><h2 id=conclusions>Conclusions</h2><p>As you can see, I was able to achieve a fairly good fit. Keep in mind, the values I found will probably stray a bit if you use the servo at a different supply voltages. But the fit I was able to achieve seems pretty good for estimating servo performance going forward. This model is not good for estimating the electrical efficiency, though, because our guesses for $k_e$ were not really validated or measured, and the true internal losses are not known. Without a power meter on the electrical side, I won&rsquo;t be able to understand how much electrical energy it takes to achieve the motion I observed.</p><p>For the purposes of understanding the ability of our motors to generate mechanical power, though this model works.</p><h2 id=external-references>External References</h2><p>I used the following resources in the last two articles</p><ul><li><a href=https://www.princeton.edu/~mae412/TEXT/NTRAK2002/292-302.pdf>https://www.princeton.edu/~mae412/TEXT/NTRAK2002/292-302.pdf</a></li><li><a href=https://www.auselectronicsdirect.com.au/assets/brochures/TA0132.pdf>https://www.auselectronicsdirect.com.au/assets/brochures/TA0132.pdf</a></li><li><a href=https://components101.com/sites/default/files/component_datasheet/SG90%20Servo%20Motor%20Datasheet.pdf>https://components101.com/sites/default/files/component_datasheet/SG90%20Servo%20Motor%20Datasheet.pdf</a></li><li><a href=https://www.researchgate.net/publication/353754375>https://www.researchgate.net/publication/353754375</a></li><li><a href="https://www.kjell.com/globalassets/mediaassets/701916_87897_datasheet_en.pdf?ref=4287817A7A">https://www.kjell.com/globalassets/mediaassets/701916_87897_datasheet_en.pdf?ref=4287817A7A</a></li><li><a href=https://www.mpja.com/download/31002md%20data.pdf>https://www.mpja.com/download/31002md%20data.pdf</a></li><li><a href=http://www.ee.ic.ac.uk/pcheung/teaching/DE1_EE/stores/sg90_datasheet.pdf>http://www.ee.ic.ac.uk/pcheung/teaching/DE1_EE/stores/sg90_datasheet.pdf</a></li></ul><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python></code></pre></div></div></div></div></div></section><footer class=text-capitalize><div class=container><div class="row justify-content-center"><div class="col-12 border-top py-4 text-center"></div><div class="col-lg-4 col-sm-6 mb-5 text-center"><h6 class=mb-4>Contact Me</h6><ul class=list-unstyled><li class=mb-3><i class="ti-location-pin mr-3 text-primary"></i>Arizona, USA</li></li></ul></div><div class="col-lg-4 col-sm-6 mb-5 text-center"><h6 class=mb-4>External</h6><ul class=list-unstyled><li class=mb-3><a class=text-dark href=https://github.com/danb0b>personal github</a></li><li class=mb-3><a class=text-dark href=https://www.linkedin.com/in/dan-aukes-502995212/>linkedin</a></li></ul></div><div class="col-lg-4 col-sm-6 mb-5 text-center"><h6 class=mb-4>Quick Links</h6><ul class=list-unstyled><li class=mb-3><a class=text-dark href=https://www.danaukes.com/about/>About</a></li><li class=mb-3><a class=text-dark href=https://idealab-asu.slack.com>IDEAlab Slack</a></li><li class=mb-3><a class=text-dark href=https://www.danaukes.com/contact/>Contact</a></li><li class=mb-3><a class=text-dark href=https://scram-workspace.slack.com>SCRAMbots</a></li><li class=mb-3><a class=text-dark href=https://www.danaukes.com/calendar/>Calendar</a></li><li class=mb-3><a class=text-dark href=https://kaiteki-asu.slack.com>Kaiteki</a></li></ul></div><div class="col-12 mb-5 text-center"><a href=https://www.danaukes.com/><img src=https://www.danaukes.com/da-small.png alt="Dan Aukes"></a></div><div class="col-12 mb-5 text-center"><p>| copyright  2023 Daniel Aukes. All Rights Reserved. |</p><p><a href=https://github.com/danb0b/danb0b.github.io/edit/master/content/work-blog/2023-12-07-servo-fitting/index.md>Edit this Page</a></p></div></div></div></footer><script>var indexURL="https://www.danaukes.com/index.json"</script><script src=https://www.danaukes.com/plugins/glightbox/js/glightbox.js></script><script src=https://www.danaukes.com/plugins/jQuery/jquery.min.js></script><script src=https://www.danaukes.com/plugins/bootstrap/bootstrap.min.js></script><script src=https://www.danaukes.com/plugins/slick/slick.min.js></script><script src=https://www.danaukes.com/plugins/venobox/venobox.min.js></script><script src=https://www.danaukes.com/plugins/search/fuse.min.js></script><script src=https://www.danaukes.com/plugins/search/mark.js></script><script src=https://www.danaukes.com/plugins/search/search.js></script><script src=https://www.danaukes.com/js/script.min.js></script><script>var lightboxDescription,lightboxVideo,lightboxInlineIframe,lightbox=GLightbox();lightbox.on("open",e=>{console.log("lightbox opened")}),lightboxDescription=GLightbox({selector:".glightbox2"}),lightboxVideo=GLightbox({selector:".glightbox3"}),lightboxVideo.on("slide_changed",({prev:e,current:t})=>{console.log("Prev slide",e),console.log("Current slide",t);const{slideIndex:s,slideNode:o,slideConfig:i,player:n}=t;n&&(n.ready||n.on("ready",e=>{}),n.on("play",e=>{console.log("Started play")}),n.on("volumechange",e=>{console.log("Volume change")}),n.on("ended",e=>{console.log("Video ended")}))}),lightboxInlineIframe=GLightbox({selector:".glightbox4"})</script></body></html>