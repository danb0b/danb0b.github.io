<!doctype html><html lang=en-us><head><meta charset=utf-8><title>Micro Servo Data Collection, Parameter Identification, and Modeling: Parts 1-4 | Dan Aukes </title><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=description content="Dan Aukes' personal website"><meta name=author content="Dan Aukes"><meta name=generator content="Hugo 0.147.3"><link rel=stylesheet href=https://www.danaukes.com/plugins/glightbox/css/glightbox.css><link rel=stylesheet href=https://www.danaukes.com/plugins/bootstrap/bootstrap.min.css><link rel=stylesheet href=https://www.danaukes.com/plugins/slick/slick.css><link rel=stylesheet href=https://www.danaukes.com/plugins/themify-icons/themify-icons.css><link rel=stylesheet href=https://www.danaukes.com/plugins/venobox/venobox.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css><link rel=stylesheet href=https://www.danaukes.com/scss/style.min.css media=screen><link rel="shortcut icon" href=https://www.danaukes.com/images/favicon.png type=image/x-icon><link rel=icon href=https://www.danaukes.com/images/favicon.png type=image/x-icon><script>(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)})(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","","auto"),ga("send","pageview")</script><script>MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]],processEscapes:!0,processEnvironments:!0},options:{skipHtmlTags:["script","noscript","style","textarea","pre"]}},window.addEventListener("load",e=>{document.querySelectorAll("mjx-container").forEach(function(e){e.parentElement.classList+="has-jax"})})</script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script></head><body><div class=preloader></div><header class=navigation><div class=container><nav class="navbar navbar-expand-lg navbar-white bg-transparent border-bottom pl-0"><a class="navbar-brand mobile-view" href=https://www.danaukes.com/><img class=img-fluid src=https://www.danaukes.com/da-small.png alt="Dan Aukes"></a>
<button class="navbar-toggler border-0" type=button data-toggle=collapse data-target=#navigation>
<i class=ti-menu></i></button><div class="collapse navbar-collapse text-center" id=navigation><div class=desktop-view><ul class="navbar-nav mr-auto"><li class=nav-item><a class=nav-link href=https://github.com/danb0b><i class=ti-github></i></a></li><li class=nav-item><a class=nav-link href=https://www.linkedin.com/in/dan-aukes-502995212/><i class=ti-linkedin></i></a></li></ul></div><a class="navbar-brand mx-auto desktop-view" href=https://www.danaukes.com/><img class=img-fluid src=https://www.danaukes.com/da-small.png alt="Dan Aukes"></a><ul class=navbar-nav><li class=nav-item><a class=nav-link href=https://www.danaukes.com/work-blog/>Work Blog</a></li><li class=nav-item><a class=nav-link href=https://www.danaukes.com/notebook/>Notebook</a></li><li class=nav-item><a class=nav-link href=https://www.danaukes.com/travel/>Travel</a></li><li class=nav-item><a class=nav-link href=https://www.danaukes.com/recipes/>Recipes</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>Misc</a><div class=dropdown-menu><a class=dropdown-item href=https://www.danaukes.com/code/>Code</a>
<a class=dropdown-item href=https://www.danaukes.com/websites/>Websites</a>
<a class=dropdown-item href=https://www.danaukes.com/bookmarks/>Bookmarks</a></div></li></ul><form action=https://www.danaukes.com//search class=d-flex><input class="form-control me-2" id=search-query name=s type=s placeholder=Search aria-label=Search>
<button class="btn btn-outline-success" type=submit><i class="ti-search text-dark"></i></button></form></div></nav></div></header><section class=section-sm><div class=container><div class=row><div class="col-lg-8 mx-auto"><div class=text-center><nav aria-label=breadcrumb><ol class=breadcrumb><li class=breadcrumb-item><a href=https://www.danaukes.com/>Welcome</a></li><li class=breadcrumb-item><a href=https://www.danaukes.com/work-blog/>Work Blog</a></li><li class="breadcrumb-item active"><a href=https://www.danaukes.com/work-blog/2023-12-01-servo-modeling/>Micro Servo Data Collection, Parameter Identification, and Modeling: Parts 1-4</a></li></ol></nav></div><h2>Micro Servo Data Collection, Parameter Identification, and Modeling: Parts 1-4</h2><div class="mb-1 post-meta"><span>By Dan Aukes</span></div><ul class=list-inline></ul><div class="content mb-5"><h2 id=introduction>Introduction</h2><p>Finding good information on low-cost servos is difficult. In the next articles, I will describe my informal journey finding and identifying the motor parameters for a SG90 9-gram servo motor. These motors are ubiquitous at the low end of robotics parts, and are thus quite attractive for making affordable robots in the classroom. The quality of these motors varies widely, however, and little information has been collected on them in one place. Different manufacturers often give only some specifications.</p><p>So here is my attempt at modeling an SG90 servo using as much information as I could find on the web, plus a little elbow grease to put it all together.</p><h3 id=parts>Parts</h3><p>I used only tools I would imagine a resourceful citizen scientist would have, including:</p><ul><li>A cell phone for capturing video</li><li>A selfie-stick tripod and mount for attaching my cell phone (you can use a chair, books, tape, etc to rig up your own mount if you don&rsquo;t have one.)</li><li>A single SG-90 servo.</li><li>A single AA battery for some added inertia</li><li>Wire to physically attach the battery</li><li>A breadboard</li><li>An ESP32 for sending position commands</li></ul><p>Other tools that would have greatly helped include a multimeter with current sensing and USB data output, oscilloscope, or current sensor. These tools would have let me measure current usage over time, including at startup/stall and in no-load conditions. Without this tool, I had to rely on manufacturers&rsquo; data sheets and my own memory of prior tests.</p><h3 id=software>Software</h3><p>I already have my computer set up with the following tools</p><ul><li>VSCode for interacting with the ESP32 and micropython</li><li>An ESP32 flashed with micropython</li><li>An anaconda distribution with mujoco and jupyter lab installed</li></ul><h2 id=procedure>Procedure</h2><blockquote><p><strong>Note:</strong> In case you don&rsquo;t have the parts on hand you can still follow along with the data. The tracker project file (with video) is linked <a href=PXL_20231113_084958377.trz>here</a> and the .csv output can be found <a href=data.csv>here</a></p></blockquote><h3 id=part-1-the-experiment>Part 1: The Experiment</h3><ol><li><p>I flashed micropython onto the ESP32 and crafted a simple program to alternate the servo 180 degrees every 2 seconds. I won&rsquo;t go into detail on this step here, but feel free to poke around my website for other resources on ESP32, micropython, and servos. The code looked like this:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>machine</span> <span style=color:#f92672>import</span> <span style=color:#111>Pin</span><span style=color:#111>,</span> <span style=color:#111>PWM</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>time</span> <span style=color:#f92672>import</span> <span style=color:#111>sleep</span>
</span></span><span style=display:flex><span><span style=color:#111>frequency</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>50</span>
</span></span><span style=display:flex><span><span style=color:#111>range_low</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>28</span>
</span></span><span style=display:flex><span><span style=color:#111>range_high</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>122</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>servo1</span> <span style=color:#f92672>=</span> <span style=color:#111>PWM</span><span style=color:#111>(</span><span style=color:#111>Pin</span><span style=color:#111>(</span><span style=color:#ae81ff>14</span><span style=color:#111>),</span><span style=color:#111>frequency</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>while</span><span style=color:#111>(</span><span style=color:#00a8c8>True</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#111>servo1</span><span style=color:#f92672>.</span><span style=color:#111>duty</span><span style=color:#111>(</span><span style=color:#111>range_low</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>sleep</span><span style=color:#111>(</span><span style=color:#ae81ff>1</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>servo1</span><span style=color:#f92672>.</span><span style=color:#111>duty</span><span style=color:#111>(</span><span style=color:#111>range_high</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>sleep</span><span style=color:#111>(</span><span style=color:#ae81ff>1</span><span style=color:#111>)</span>
</span></span></code></pre></div></li><li><p>I then plugged in my ESP32 to a half-size breadboard and wired up my servo. I hung the end of the servo off the edge of a desk and weighted it down so it wouldn&rsquo;t move.</p></li><li><p>I wrapped a wire around my AA battery to rigidly attach it to the servo&rsquo;s horn. I mounted the battery so it was mounted symmetrically about the rotational center of the servo.</p><figure><img src=/work-blog/2023-12-01-servo-modeling/PXL_20231129_164917375.jpg alt="My Inertial Load" width=50%><figcaption><p>My Inertial Load</p></figcaption></figure></li><li><p>I weighed my battery for use later</p><figure><img src=/work-blog/2023-12-01-servo-modeling/PXL_20231113_081629467.jpg alt="Weighing my mass" width=50%><figcaption><p>Weighing my mass</p></figcaption></figure></li><li><p>I used a small tripod to hold my cell phone approximately 12 inches away from my scene. I made sure my servo was in the center of my frame, that my camera was perpendicular to the plane of my experiment, and that my zoom was such that I was not using the &ldquo;fish-eye&rdquo; lens of my camera&mldr;in the case of a google pixel 6a, anything less than 1x uses the fish-eye lens that exhibits more warping around the edges. I did not bother to zoom in much, though, since I am not sure where digital zoom takes over. (Digital zoom doesn&rsquo;t add any more information to the experiment, and can result in a worse image due to the extra image processing performed by the camera.)</p><figure><img src=/work-blog/2023-12-01-servo-modeling/PXL_20231129_165723609.jpg alt="The camera mount" width=50%><figcaption><p>The camera mount</p></figcaption></figure><blockquote><p><strong>Note 1:</strong> It is important that your scene is as centered as possible in your image, and that the plane of motion is as perpendicular as possible to your camera lens&rsquo;s radial axis. This will minimize the amount of warping seen in your image.</p></blockquote><blockquote><p><strong>Note 2:</strong> It should be noted that this is an informal approach to optical tracking. Camera calibration and knowledge of how lens distortion works should be utilized at this step when adapting my approach to a lab setting, but again, this article is focused on &ldquo;good-enough&rdquo; citizen science techniques, or techniques you can actually apply in a single, 75-minute class.</p></blockquote></li><li><p>I took several practice videos and checked them to ensure the camera didn&rsquo;t move, the base of the servo didn&rsquo;t shake or move, and that my scene was well-lit and in focus.</p></li></ol><figure><img src=/work-blog/2023-12-01-servo-modeling/video-still.png alt="The servo stopped; no blur visible"><figcaption><p>The servo stopped; no blur visible</p></figcaption></figure><figure><img src=/work-blog/2023-12-01-servo-modeling/video-motion.png alt="The servo moving; it is still relatively easy to identify key points"><figcaption><p>The servo moving; it is still relatively easy to identify key points</p></figcaption></figure><h3 id=part-2-image-tracking>Part 2: Image tracking</h3><figure><img src=/work-blog/2023-12-01-servo-modeling/tracker-screenshot.png alt="Tracker Screenshot"><figcaption><p>Tracker Screenshot</p></figcaption></figure><p>I installed tracker on a Windows computer and imported my video. I identified several high-contrast points that remained visible even during the blurry bits when the servo was rotating. Tracker has the ability to follow marked points forward in time once you mark them. It follows the key point for as many frames as it can. I would call this a semi-automatic process. In my case, I found tracker&rsquo;s tools to be only moderately helpful as the quality of my video was so low. But I was able to manually find most points tracker couldn&rsquo;t; tracker filled in the gaps when the servo was not moving.</p><p>I have a full tutorial on tracker associated with my foldable robotics class. Please see that for more information (as well as more tips on scene setup). A couple tips here though:</p><ul><li>I used the edge of the desk as my x-axis reference line, to ensure the x-y coordinate system matched up with a planar model with gravity in the -y direction.</li></ul><p>I output the data as a <a href=data.csv>.csv file</a>. Opening the file, I removed the two excess lines above the column labels. the Pandas package in python expects only one row above data, for heading labels. Once done, I saved the file to the same file name.</p><h3 id=part-3-massaging-the-data>Part 3: Massaging the Data</h3><p>In this part, lets summarize the information we have and the information we need. First, we have a given orientation of our recorded image frames because we captured the (supposedly) horizontal level of the desk. It would have been better to verify the level of the desk&mldr;but it is what it is. We have two tracked points. We don&rsquo;t have the location of the servo relative to those points, and we don&rsquo;t specifically have the center of rotation. That will be the first issue. We also don&rsquo;t exactly know the mass distribution of the battery as it was actually attached to the servo, but for this experiment we will assume we did a good job at centering it. A potential improvement on the last step would be to measure the distance to the battery&rsquo;s boundaries at specific points in time to confirm it was roughly centered around the servo&rsquo;s rotational axis. We can go back and add that later to the tracker project if we feel we need more precision.</p><p>Now let&rsquo;s talk about what we need. Do we need the position of the servo? no. Do we need the position of particular points of the battery? No.</p><blockquote><p>All we really want to know is how fast does the servo accelerate with an extra inertia attached to its output.</p></blockquote><p>All other data can be obtained through electrical experiments, off the manufacturer&rsquo;s data sheet, or through first principles equations. So let&rsquo;s work on converting our captured data points into an angular measurement, $\theta$, that we can then compare to a dynamic model.</p><p>First, let&rsquo;s import some necessary packages in python&mldr;</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>pandas</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>scipy.signal</span> <span style=color:#00a8c8>as</span> <span style=color:#111>ss</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>scipy.optimize</span> <span style=color:#00a8c8>as</span> <span style=color:#111>so</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>numpy</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>matplotlib.pyplot</span> <span style=color:#00a8c8>as</span> <span style=color:#111>plt</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>math</span>
</span></span></code></pre></div><p>Next, we import data collected by tracker and identify the useful columns</p><blockquote><p><strong>Reminder:</strong> You will need to open the .csv file to remove the first two rows. Pandas expects just one row for column names above the data</p></blockquote><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>data</span> <span style=color:#f92672>=</span> <span style=color:#111>pandas</span><span style=color:#f92672>.</span><span style=color:#111>read_csv</span><span style=color:#111>(</span><span style=color:#d88200>&#39;data.csv&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>data</span><span style=color:#f92672>.</span><span style=color:#111>columns</span>
</span></span></code></pre></div><pre><code>Index(['t', 'x', 'y', 'x.1', 'y.1'], dtype='object')
</code></pre><p>Extract the time and position data of our markers</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>t</span> <span style=color:#f92672>=</span> <span style=color:#111>data</span><span style=color:#111>[</span><span style=color:#d88200>&#39;t&#39;</span><span style=color:#111>]</span>
</span></span></code></pre></div><h3 id=challenge-finding-the-center-of-rotation>Challenge: Finding the center of rotation</h3><p>The issue with my simple experiment was that it was quite hard to mark or estimate the center of rotation prior to the experiment. Now that I have video data, though, I can make an estimate abou the center of rotation by using the tracking data obtained from my marked points. In the next few chunks of code you&rsquo;ll see how I went about identifying the best guess for the center of rotation.</p><p>First, make a guess for the center of rotation by finding the mean of all the x and y data of our first point. This is rough but it should be close enough for an optimizer to do the rest</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>xini</span> <span style=color:#f92672>=</span> <span style=color:#111>data</span><span style=color:#111>[</span><span style=color:#d88200>&#39;x&#39;</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>mean</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#111>yini</span> <span style=color:#f92672>=</span> <span style=color:#111>data</span><span style=color:#111>[</span><span style=color:#d88200>&#39;y&#39;</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>mean</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#111>ini</span> <span style=color:#f92672>=</span> <span style=color:#111>numpy</span><span style=color:#f92672>.</span><span style=color:#111>array</span><span style=color:#111>([</span><span style=color:#111>xini</span><span style=color:#111>,</span><span style=color:#111>yini</span><span style=color:#111>])</span>
</span></span><span style=display:flex><span><span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>ini</span><span style=color:#111>)</span>
</span></span></code></pre></div><pre><code>[2.55072079 0.21735663]
</code></pre><p>Next, create a function that finds the sum of squared radii given an x,y coordinate guess for the center of rotation, across the two points tracked. By obtaining the distance from the guessed center to each point over all the data, the true center should minimize the sum of all distances to all tracked points.</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>fun</span><span style=color:#111>(</span><span style=color:#111>guess</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># break out guess into two variables, x0 and y0</span>
</span></span><span style=display:flex><span>    <span style=color:#111>x0</span><span style=color:#111>,</span><span style=color:#111>y0</span> <span style=color:#f92672>=</span> <span style=color:#111>guess</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># start with zero error</span>
</span></span><span style=display:flex><span>    <span style=color:#111>error</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># sum the squared length to point 1 over all time and add to error</span>
</span></span><span style=display:flex><span>    <span style=color:#111>error</span> <span style=color:#f92672>+=</span> <span style=color:#111>((</span><span style=color:#111>data</span><span style=color:#111>[</span><span style=color:#d88200>&#39;x&#39;</span><span style=color:#111>]</span><span style=color:#f92672>-</span><span style=color:#111>x0</span><span style=color:#111>)</span><span style=color:#f92672>**</span><span style=color:#ae81ff>2</span><span style=color:#f92672>+</span><span style=color:#111>(</span><span style=color:#111>data</span><span style=color:#111>[</span><span style=color:#d88200>&#39;y&#39;</span><span style=color:#111>]</span><span style=color:#f92672>-</span><span style=color:#111>y0</span><span style=color:#111>)</span><span style=color:#f92672>**</span><span style=color:#ae81ff>2</span><span style=color:#111>)</span><span style=color:#f92672>.</span><span style=color:#111>sum</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># sum the squared length to point 2 over all time and add to error</span>
</span></span><span style=display:flex><span>    <span style=color:#111>error</span> <span style=color:#f92672>+=</span> <span style=color:#111>((</span><span style=color:#111>data</span><span style=color:#111>[</span><span style=color:#d88200>&#39;x.1&#39;</span><span style=color:#111>]</span><span style=color:#f92672>-</span><span style=color:#111>x0</span><span style=color:#111>)</span><span style=color:#f92672>**</span><span style=color:#ae81ff>2</span><span style=color:#f92672>+</span><span style=color:#111>(</span><span style=color:#111>data</span><span style=color:#111>[</span><span style=color:#d88200>&#39;y.1&#39;</span><span style=color:#111>]</span><span style=color:#f92672>-</span><span style=color:#111>y0</span><span style=color:#111>)</span><span style=color:#f92672>**</span><span style=color:#ae81ff>2</span><span style=color:#111>)</span><span style=color:#f92672>.</span><span style=color:#111>sum</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># take the square root</span>
</span></span><span style=display:flex><span>    <span style=color:#111>error</span> <span style=color:#f92672>=</span> <span style=color:#111>error</span><span style=color:#f92672>**</span><span style=color:#ae81ff>.5</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># return the error</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>error</span>
</span></span></code></pre></div><p>The function, evaluated at the initial guess should provide a baseline error that can go lower still</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>fun</span><span style=color:#111>(</span><span style=color:#111>ini</span><span style=color:#111>))</span>
</span></span></code></pre></div><pre><code>18.010570547148244
</code></pre><p>Run the minimization and check the result</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>result</span> <span style=color:#f92672>=</span> <span style=color:#111>so</span><span style=color:#f92672>.</span><span style=color:#111>minimize</span><span style=color:#111>(</span><span style=color:#111>fun</span><span style=color:#111>,</span><span style=color:#111>ini</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>result</span>
</span></span></code></pre></div><pre><code>  message: Optimization terminated successfully.
  success: True
   status: 0
      fun: 17.655446173747816
        x: [ 2.719e+00  2.522e-01]
      nit: 4
      jac: [-7.153e-07  0.000e+00]
 hess_inv: [[ 8.129e-02 -1.918e-01]
            [-1.918e-01  9.600e-01]]
     nfev: 21
     njev: 7
</code></pre><p>Compute the vectors from the origin to the two tracked points. This will effectively shift the original tracked points to move about the result of our optimization, the selected center of rotation in the video.</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>v1</span> <span style=color:#f92672>=</span> <span style=color:#111>numpy</span><span style=color:#f92672>.</span><span style=color:#111>array</span><span style=color:#111>([</span><span style=color:#111>data</span><span style=color:#111>[</span><span style=color:#d88200>&#39;x&#39;</span><span style=color:#111>]</span><span style=color:#f92672>-</span><span style=color:#111>result</span><span style=color:#f92672>.</span><span style=color:#111>x</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>],(</span><span style=color:#111>data</span><span style=color:#111>[</span><span style=color:#d88200>&#39;y&#39;</span><span style=color:#111>]</span><span style=color:#f92672>-</span><span style=color:#111>result</span><span style=color:#f92672>.</span><span style=color:#111>x</span><span style=color:#111>[</span><span style=color:#ae81ff>1</span><span style=color:#111>])])</span><span style=color:#f92672>.</span><span style=color:#111>T</span>
</span></span><span style=display:flex><span><span style=color:#111>v2</span> <span style=color:#f92672>=</span> <span style=color:#111>numpy</span><span style=color:#f92672>.</span><span style=color:#111>array</span><span style=color:#111>([</span><span style=color:#111>data</span><span style=color:#111>[</span><span style=color:#d88200>&#39;x.1&#39;</span><span style=color:#111>]</span><span style=color:#f92672>-</span><span style=color:#111>result</span><span style=color:#f92672>.</span><span style=color:#111>x</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>],(</span><span style=color:#111>data</span><span style=color:#111>[</span><span style=color:#d88200>&#39;y.1&#39;</span><span style=color:#111>]</span><span style=color:#f92672>-</span><span style=color:#111>result</span><span style=color:#f92672>.</span><span style=color:#111>x</span><span style=color:#111>[</span><span style=color:#ae81ff>1</span><span style=color:#111>])])</span><span style=color:#f92672>.</span><span style=color:#111>T</span>
</span></span></code></pre></div><p>Plot the vectors over time, along with a dot at the origin.</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>plt</span><span style=color:#f92672>.</span><span style=color:#111>plot</span><span style=color:#111>(</span><span style=color:#111>v1</span><span style=color:#111>[:,</span><span style=color:#ae81ff>0</span><span style=color:#111>],</span><span style=color:#111>v1</span><span style=color:#111>[:,</span><span style=color:#ae81ff>1</span><span style=color:#111>])</span>
</span></span><span style=display:flex><span><span style=color:#111>plt</span><span style=color:#f92672>.</span><span style=color:#111>plot</span><span style=color:#111>(</span><span style=color:#111>v2</span><span style=color:#111>[:,</span><span style=color:#ae81ff>0</span><span style=color:#111>],</span><span style=color:#111>v2</span><span style=color:#111>[:,</span><span style=color:#ae81ff>1</span><span style=color:#111>])</span>
</span></span><span style=display:flex><span><span style=color:#111>plt</span><span style=color:#f92672>.</span><span style=color:#111>plot</span><span style=color:#111>(</span><span style=color:#ae81ff>0</span><span style=color:#111>,</span><span style=color:#ae81ff>0</span><span style=color:#111>,</span><span style=color:#d88200>&#39;ro&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>plt</span><span style=color:#f92672>.</span><span style=color:#111>axis</span><span style=color:#111>(</span><span style=color:#d88200>&#39;equal&#39;</span><span style=color:#111>)</span>
</span></span></code></pre></div><pre><code>(-1.0102513998296843,
 0.8169597001703157,
 -1.101215392464636,
 1.0497984175353638)
</code></pre><figure><img src=/work-blog/2023-12-01-servo-modeling/output_17_1.png alt="Circular Motion"><figcaption><p>Circular Motion</p></figcaption></figure><p>The angle of each vector can be computed by taking the arctan of the x and y components of vector 1 and 2. Plot the result.</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>theta_v1</span> <span style=color:#f92672>=</span> <span style=color:#111>numpy</span><span style=color:#f92672>.</span><span style=color:#111>arctan2</span><span style=color:#111>(</span><span style=color:#111>v1</span><span style=color:#111>[:,</span><span style=color:#ae81ff>1</span><span style=color:#111>],</span><span style=color:#111>v1</span><span style=color:#111>[:,</span><span style=color:#ae81ff>0</span><span style=color:#111>])</span>
</span></span><span style=display:flex><span><span style=color:#111>theta_v2</span> <span style=color:#f92672>=</span> <span style=color:#111>numpy</span><span style=color:#f92672>.</span><span style=color:#111>arctan2</span><span style=color:#111>(</span><span style=color:#111>v2</span><span style=color:#111>[:,</span><span style=color:#ae81ff>1</span><span style=color:#111>],</span><span style=color:#111>v2</span><span style=color:#111>[:,</span><span style=color:#ae81ff>0</span><span style=color:#111>])</span>
</span></span><span style=display:flex><span><span style=color:#111>plt</span><span style=color:#f92672>.</span><span style=color:#111>plot</span><span style=color:#111>(</span><span style=color:#111>t</span><span style=color:#111>,</span><span style=color:#111>theta_v1</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>plt</span><span style=color:#f92672>.</span><span style=color:#111>plot</span><span style=color:#111>(</span><span style=color:#111>t</span><span style=color:#111>,</span><span style=color:#111>theta_v2</span><span style=color:#111>)</span>
</span></span></code></pre></div><pre><code>[&lt;matplotlib.lines.Line2D at 0x7f4e40ade990&gt;]
</code></pre><figure><img src=/work-blog/2023-12-01-servo-modeling/output_19_1.png alt="Rotation Angle with atan2 jumps."><figcaption><p>Rotation Angle with atan2 jumps.</p></figcaption></figure><p>This data has some discrete jumps in it, though. Why? The issue is that the theta value recovered &ldquo;jumps&rdquo; when it exceeds $|\pi|$. We can further work with the data to &ldquo;unwrap this value. Any value that jumps more than $\pi$ between individual timesteps by the arctan2 function can be interpreted to actually be continuously increasing (or decreasing) past that value. We just need to keep track of how many times from the beginning of our data we have crossed this threshold, and add it to our original measurement. Thus, we have the <code>unwrap()</code> function.</p><blockquote><p><strong>Note:</strong> Scipy / Numpy has an unwrap function but it doesn&rsquo;t seem to work for me&mldr;thus, I wrote my own.</p></blockquote><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>unwrap</span><span style=color:#111>(</span><span style=color:#111>theta</span><span style=color:#111>,</span><span style=color:#111>period</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#create a holder for our new theta measurement, theta2, and seed it with the initial value of theta.</span>
</span></span><span style=display:flex><span>    <span style=color:#111>theta2</span> <span style=color:#f92672>=</span> <span style=color:#111>[</span><span style=color:#111>theta</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>]]</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#we need to compare our current theta measurement against the previous one.  thus, we store the initial value so there are no initial jumps.</span>
</span></span><span style=display:flex><span>    <span style=color:#111>last_theta</span> <span style=color:#f92672>=</span> <span style=color:#111>theta</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#create a holder for the number of times we have transitioned through another period</span>
</span></span><span style=display:flex><span>    <span style=color:#111>mem</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Starting at our 2nd data point(index 1)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>for</span> <span style=color:#111>t_ii</span><span style=color:#111>,</span><span style=color:#111>item</span> <span style=color:#f92672>in</span> <span style=color:#111>zip</span><span style=color:#111>(</span><span style=color:#111>t</span><span style=color:#111>[</span><span style=color:#ae81ff>1</span><span style=color:#111>:],</span><span style=color:#111>theta</span><span style=color:#111>[</span><span style=color:#ae81ff>1</span><span style=color:#111>:]):</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>#compare our current theta against the last theta</span>
</span></span><span style=display:flex><span>        <span style=color:#111>dt</span> <span style=color:#f92672>=</span> <span style=color:#111>(</span><span style=color:#111>item</span> <span style=color:#f92672>-</span> <span style=color:#111>last_theta</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>#check if there is a big jump in the positive or negative direction, and if there is, subtract or add one period value to mem</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#111>dt</span><span style=color:#f92672>&gt;</span><span style=color:#111>(</span><span style=color:#111>period</span><span style=color:#f92672>/</span><span style=color:#ae81ff>2</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>            <span style=color:#111>mem</span><span style=color:#f92672>-=</span><span style=color:#111>period</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#111>dt</span><span style=color:#f92672>&lt;</span><span style=color:#111>(</span><span style=color:#f92672>-</span><span style=color:#111>period</span><span style=color:#f92672>/</span><span style=color:#ae81ff>2</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>            <span style=color:#111>mem</span><span style=color:#f92672>+=</span><span style=color:#111>period</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e># compute the corrected value of theta and add to theta2</span>
</span></span><span style=display:flex><span>        <span style=color:#111>theta2</span><span style=color:#f92672>.</span><span style=color:#111>append</span><span style=color:#111>(</span><span style=color:#111>item</span><span style=color:#f92672>+</span><span style=color:#111>mem</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># update last_theta</span>
</span></span><span style=display:flex><span>        <span style=color:#111>last_theta</span> <span style=color:#f92672>=</span> <span style=color:#111>item</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#75715e># reform theta2 as a numpy array</span>
</span></span><span style=display:flex><span>    <span style=color:#111>theta2</span> <span style=color:#f92672>=</span> <span style=color:#111>numpy</span><span style=color:#f92672>.</span><span style=color:#111>array</span><span style=color:#111>(</span><span style=color:#111>theta2</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># and return it</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>theta2</span>
</span></span></code></pre></div><p>now run the function on our two guesses for vector 1 and vector 2</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>theta_v1_u</span> <span style=color:#f92672>=</span> <span style=color:#111>unwrap</span><span style=color:#111>(</span><span style=color:#111>theta_v1</span><span style=color:#111>,</span><span style=color:#ae81ff>2</span><span style=color:#f92672>*</span><span style=color:#111>math</span><span style=color:#f92672>.</span><span style=color:#111>pi</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>theta_v2_u</span> <span style=color:#f92672>=</span> <span style=color:#111>unwrap</span><span style=color:#111>(</span><span style=color:#111>theta_v2</span><span style=color:#111>,</span><span style=color:#ae81ff>2</span><span style=color:#f92672>*</span><span style=color:#111>math</span><span style=color:#f92672>.</span><span style=color:#111>pi</span><span style=color:#111>)</span>
</span></span></code></pre></div><p>By subtracting the initial values for theta_1 and theta_2 we obtain two guesses for the same angle value.</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>theta_v1_u</span><span style=color:#f92672>-=</span><span style=color:#111>theta_v1_u</span><span style=color:#f92672>.</span><span style=color:#111>min</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#111>theta_v2_u</span><span style=color:#f92672>-=</span><span style=color:#111>theta_v2_u</span><span style=color:#f92672>.</span><span style=color:#111>min</span><span style=color:#111>()</span>
</span></span></code></pre></div><p>Plot the corrected values</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>plt</span><span style=color:#f92672>.</span><span style=color:#111>plot</span><span style=color:#111>(</span><span style=color:#111>t</span><span style=color:#111>,</span><span style=color:#111>theta_v1_u</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>plt</span><span style=color:#f92672>.</span><span style=color:#111>plot</span><span style=color:#111>(</span><span style=color:#111>t</span><span style=color:#111>,</span><span style=color:#111>theta_v2_u</span><span style=color:#111>)</span>
</span></span></code></pre></div><pre><code>[&lt;matplotlib.lines.Line2D at 0x7f4e4150a010&gt;]
</code></pre><figure><img src=/work-blog/2023-12-01-servo-modeling/output_27_1.png alt="The two measurements"><figcaption><p>The two measurements</p></figcaption></figure><p>Compute the average of these two samples. Adding even more points to this analysis would give us a more accurate measurement of theta.</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>theta_u</span> <span style=color:#f92672>=</span> <span style=color:#111>(</span><span style=color:#111>theta_v1_u</span><span style=color:#f92672>+</span><span style=color:#111>theta_v2_u</span><span style=color:#111>)</span><span style=color:#f92672>/</span><span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span><span style=color:#111>plt</span><span style=color:#f92672>.</span><span style=color:#111>plot</span><span style=color:#111>(</span><span style=color:#111>t</span><span style=color:#111>,</span><span style=color:#111>theta_v1_u</span><span style=color:#111>,</span><span style=color:#d88200>&#39;b:&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>plt</span><span style=color:#f92672>.</span><span style=color:#111>plot</span><span style=color:#111>(</span><span style=color:#111>t</span><span style=color:#111>,</span><span style=color:#111>theta_v2_u</span><span style=color:#111>,</span><span style=color:#d88200>&#39;b:&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>plt</span><span style=color:#f92672>.</span><span style=color:#111>plot</span><span style=color:#111>(</span><span style=color:#111>t</span><span style=color:#111>,</span><span style=color:#111>theta_u</span><span style=color:#111>,</span><span style=color:#d88200>&#39;r-&#39;</span><span style=color:#111>)</span>
</span></span></code></pre></div><pre><code>[&lt;matplotlib.lines.Line2D at 0x7f4e40b67e50&gt;]
</code></pre><figure><img src=/work-blog/2023-12-01-servo-modeling/output_29_1.png alt="Average of the two measurements"><figcaption><p>Average of the two measurements</p></figcaption></figure><p>Out of curiosity, what is the maximum value of our guessed value of theta?</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>theta_u</span><span style=color:#f92672>.</span><span style=color:#111>max</span><span style=color:#111>()</span><span style=color:#f92672>*</span><span style=color:#ae81ff>180</span><span style=color:#f92672>/</span><span style=color:#111>math</span><span style=color:#f92672>.</span><span style=color:#111>pi</span>
</span></span></code></pre></div><pre><code>180.13261077941166
</code></pre><p>Wow!</p><h3 id=part-4-guessing-the-input-signal>Part 4: Guessing the input signal</h3><p>Because of the informal nature of the experiment, it is hard to capture the actual PWM signal and compare against the output motion of our servo. To make a good guess, however, we can reconstruct the step signal sent by the ESP32 and place it one time-step in front of any observed motion in the frames.</p><p>First, we make a filter to only look at data values less than a second, just to zoom in on the first transition</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>time_filter</span> <span style=color:#f92672>=</span> <span style=color:#111>t</span><span style=color:#f92672>&lt;</span><span style=color:#ae81ff>1</span>
</span></span></code></pre></div><p>We then find the index of the first point in time where theta starts moving in order to guess the time-delay of our first command signal. We find it hueristically by finding the theta value that more than 1% of the full range of observed thetas from min(theta), starting at t=0. We save that index as <code>jj</code>, and identify the starting time, <code>t_0</code>, using the index</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>jj</span> <span style=color:#f92672>=</span> <span style=color:#111>theta_u</span><span style=color:#111>[</span><span style=color:#111>time_filter</span><span style=color:#111>]</span> <span style=color:#f92672>&gt;</span> <span style=color:#111>(</span><span style=color:#111>theta_u</span><span style=color:#111>[</span><span style=color:#111>time_filter</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>max</span><span style=color:#111>()</span> 
</span></span><span style=display:flex><span>                             <span style=color:#f92672>-</span> <span style=color:#111>theta_u</span><span style=color:#111>[</span><span style=color:#111>time_filter</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>min</span><span style=color:#111>())</span><span style=color:#f92672>*</span><span style=color:#ae81ff>.01</span> 
</span></span><span style=display:flex><span>    <span style=color:#f92672>+</span> <span style=color:#111>theta_u</span><span style=color:#111>[</span><span style=color:#111>time_filter</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>min</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span><span style=color:#111>t_0_kk</span> <span style=color:#f92672>=</span> <span style=color:#111>(</span><span style=color:#111>t</span><span style=color:#111>[</span><span style=color:#111>time_filter</span><span style=color:#111>][</span><span style=color:#111>jj</span><span style=color:#111>])</span><span style=color:#f92672>.</span><span style=color:#111>idxmin</span><span style=color:#111>()</span> 
</span></span><span style=display:flex><span><span style=color:#111>t_0</span> <span style=color:#f92672>=</span> <span style=color:#111>t</span><span style=color:#111>[</span><span style=color:#111>t_0_kk</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span><span style=color:#111>t_0</span>
</span></span></code></pre></div><pre><code>0.5015946
</code></pre><p>We then plot the moment motion starts on top of the adjusted theta values:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>plt</span><span style=color:#f92672>.</span><span style=color:#111>plot</span><span style=color:#111>(</span><span style=color:#111>t</span><span style=color:#111>[</span><span style=color:#111>time_filter</span><span style=color:#111>],</span><span style=color:#111>theta_u</span><span style=color:#111>[</span><span style=color:#111>time_filter</span><span style=color:#111>])</span>
</span></span><span style=display:flex><span><span style=color:#111>plt</span><span style=color:#f92672>.</span><span style=color:#111>plot</span><span style=color:#111>(</span><span style=color:#111>t</span><span style=color:#111>[</span><span style=color:#111>t_0_kk</span><span style=color:#111>],</span><span style=color:#111>theta_u</span><span style=color:#111>[</span><span style=color:#111>t_0_kk</span><span style=color:#111>],</span><span style=color:#d88200>&#39;ro&#39;</span><span style=color:#111>)</span>
</span></span></code></pre></div><pre><code>[&lt;matplotlib.lines.Line2D at 0x7f4e4153e910&gt;]
</code></pre><figure><img src=/work-blog/2023-12-01-servo-modeling/output_38_1.png alt="The point motion starts"><figcaption><p>The point motion starts</p></figcaption></figure><p>This means the signal must have been sent at least one time-step before this. Maybe more, but the best-case scenario for lag would be one frame of video.</p><p>Lets create a function that can generate a step function with the following parameters</p><ul><li><code>A</code>: amplitude</li><li><code>f</code>: frequency</li><li><code>w</code>: width (as a fraction of the full time step) of the positive portion of the square wave</li><li><code>b</code>: y-offset</li></ul><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>A</span> <span style=color:#f92672>=</span> <span style=color:#111>math</span><span style=color:#f92672>.</span><span style=color:#111>pi</span>
</span></span><span style=display:flex><span><span style=color:#111>f</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>.5</span>
</span></span><span style=display:flex><span><span style=color:#111>w</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>.5</span>
</span></span><span style=display:flex><span><span style=color:#111>b</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>square</span><span style=color:#111>(</span><span style=color:#111>t</span><span style=color:#111>,</span><span style=color:#111>A</span><span style=color:#111>,</span><span style=color:#111>f</span><span style=color:#111>,</span><span style=color:#111>w</span><span style=color:#111>,</span><span style=color:#111>b</span><span style=color:#111>,</span><span style=color:#111>t_0</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#111>y</span> <span style=color:#f92672>=</span> <span style=color:#111>(</span><span style=color:#111>t</span><span style=color:#f92672>-</span><span style=color:#111>t_0</span><span style=color:#111>)</span><span style=color:#f92672>*</span><span style=color:#111>f</span> 
</span></span><span style=display:flex><span>    <span style=color:#111>y</span> <span style=color:#f92672>=</span> <span style=color:#111>y</span><span style=color:#f92672>%</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#111>y</span> <span style=color:#f92672>=</span> <span style=color:#111>(</span><span style=color:#111>y</span><span style=color:#f92672>&lt;</span><span style=color:#111>w</span><span style=color:#111>)</span><span style=color:#f92672>*</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#111>y</span> <span style=color:#f92672>=</span> <span style=color:#111>A</span><span style=color:#f92672>*</span><span style=color:#111>y</span> <span style=color:#f92672>+</span><span style=color:#111>b</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>y</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>y</span> <span style=color:#f92672>=</span> <span style=color:#111>square</span><span style=color:#111>(</span><span style=color:#111>t</span><span style=color:#111>,</span><span style=color:#111>A</span><span style=color:#111>,</span><span style=color:#111>f</span><span style=color:#111>,</span><span style=color:#111>w</span><span style=color:#111>,</span><span style=color:#111>b</span><span style=color:#111>,</span><span style=color:#111>t_0</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>plt</span><span style=color:#f92672>.</span><span style=color:#111>plot</span><span style=color:#111>(</span><span style=color:#111>t</span><span style=color:#111>[</span><span style=color:#111>time_filter</span><span style=color:#111>],</span><span style=color:#111>theta_u</span><span style=color:#111>[</span><span style=color:#111>time_filter</span><span style=color:#111>])</span>
</span></span><span style=display:flex><span><span style=color:#111>plt</span><span style=color:#f92672>.</span><span style=color:#111>plot</span><span style=color:#111>(</span><span style=color:#111>t</span><span style=color:#111>[</span><span style=color:#111>time_filter</span><span style=color:#111>],</span><span style=color:#111>y</span><span style=color:#111>[</span><span style=color:#111>time_filter</span><span style=color:#111>])</span>
</span></span><span style=display:flex><span><span style=color:#111>plt</span><span style=color:#f92672>.</span><span style=color:#111>plot</span><span style=color:#111>(</span><span style=color:#111>t</span><span style=color:#111>[</span><span style=color:#111>t_0_kk</span><span style=color:#111>],</span><span style=color:#111>theta_u</span><span style=color:#111>[</span><span style=color:#111>t_0_kk</span><span style=color:#111>],</span><span style=color:#d88200>&#39;ro&#39;</span><span style=color:#111>)</span>
</span></span></code></pre></div><pre><code>[&lt;matplotlib.lines.Line2D at 0x7f4e40c70fd0&gt;]
</code></pre><figure><img src=/work-blog/2023-12-01-servo-modeling/output_41_1.png alt="The guessed control signal"><figcaption><p>The guessed control signal</p></figcaption></figure><p>Now lets check our results over all the collected data</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>plt</span><span style=color:#f92672>.</span><span style=color:#111>plot</span><span style=color:#111>(</span><span style=color:#111>t</span><span style=color:#111>,</span><span style=color:#111>y</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>plt</span><span style=color:#f92672>.</span><span style=color:#111>plot</span><span style=color:#111>(</span><span style=color:#111>t</span><span style=color:#111>,</span><span style=color:#111>theta_u</span><span style=color:#111>)</span>
</span></span></code></pre></div><pre><code>[&lt;matplotlib.lines.Line2D at 0x7f4e40c74850&gt;]
</code></pre><figure><img src=/work-blog/2023-12-01-servo-modeling/output_43_1.png alt="Checking our work"><figcaption><p>Checking our work</p></figcaption></figure><p>it looks good! Now let&rsquo;s save some of our work for use in other code</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>data</span> <span style=color:#f92672>=</span> <span style=color:#111>{}</span>
</span></span><span style=display:flex><span><span style=color:#111>data</span><span style=color:#111>[</span><span style=color:#d88200>&#39;A&#39;</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#111>A</span>
</span></span><span style=display:flex><span><span style=color:#111>data</span><span style=color:#111>[</span><span style=color:#d88200>&#39;f&#39;</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#111>f</span>
</span></span><span style=display:flex><span><span style=color:#111>data</span><span style=color:#111>[</span><span style=color:#d88200>&#39;b&#39;</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#111>b</span>
</span></span><span style=display:flex><span><span style=color:#111>data</span><span style=color:#111>[</span><span style=color:#d88200>&#39;w&#39;</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#111>w</span>
</span></span><span style=display:flex><span><span style=color:#111>data</span><span style=color:#111>[</span><span style=color:#d88200>&#39;t&#39;</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#111>t</span>
</span></span><span style=display:flex><span><span style=color:#111>data</span><span style=color:#111>[</span><span style=color:#d88200>&#39;t_0&#39;</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#111>t_0</span>
</span></span><span style=display:flex><span><span style=color:#111>data</span><span style=color:#111>[</span><span style=color:#d88200>&#39;theta_u&#39;</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#111>theta_u</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>yaml</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>with</span> <span style=color:#111>open</span><span style=color:#111>(</span><span style=color:#d88200>&#39;servo_data_collection.yml&#39;</span><span style=color:#111>,</span><span style=color:#d88200>&#39;w&#39;</span><span style=color:#111>)</span> <span style=color:#00a8c8>as</span> <span style=color:#111>f</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>    <span style=color:#111>yaml</span><span style=color:#f92672>.</span><span style=color:#111>dump</span><span style=color:#111>(</span><span style=color:#111>data</span><span style=color:#111>,</span><span style=color:#111>f</span><span style=color:#111>)</span>
</span></span></code></pre></div><p>The resulting .yaml file can be found <a href=servo_data_collection.yml>here</a></p><p>In the next writeup, I will continue, showing off how I modeled the motor and controller, and then obtained some best-fit model parameters.</p></div></div></div></div></section><footer class=text-capitalize><div class=container><div class="row justify-content-center"><div class="col-12 border-top py-4 text-center"></div><div class="col-lg-4 col-sm-6 mb-5 text-center"><h6 class=mb-4>Contact Me</h6><ul class=list-unstyled><li class=mb-3><i class="ti-location-pin mr-3 text-primary"></i>Arizona, USA</li></li></ul></div><div class="col-lg-4 col-sm-6 mb-5 text-center"><h6 class=mb-4>External</h6><ul class=list-unstyled><li class=mb-3><a class=text-dark href=https://github.com/danb0b>personal github</a></li><li class=mb-3><a class=text-dark href=https://www.linkedin.com/in/dan-aukes-502995212/>linkedin</a></li></ul></div><div class="col-lg-4 col-sm-6 mb-5 text-center"><h6 class=mb-4>Quick Links</h6><ul class=list-unstyled><li class=mb-3><a class=text-dark href=https://www.danaukes.com/about/>About</a></li><li class=mb-3><a class=text-dark href=https://idealab-asu.slack.com>IDEAlab Slack</a></li><li class=mb-3><a class=text-dark href=https://www.danaukes.com/contact/>Contact</a></li><li class=mb-3><a class=text-dark href=https://scram-workspace.slack.com>SCRAMbots</a></li><li class=mb-3><a class=text-dark href=https://www.danaukes.com/calendar/>Calendar</a></li><li class=mb-3><a class=text-dark href=https://kaiteki-asu.slack.com>Kaiteki</a></li></ul></div><div class="col-12 mb-5 text-center"><a href=https://www.danaukes.com/><img src=https://www.danaukes.com/da-small.png alt="Dan Aukes"></a></div><div class="col-12 mb-5 text-center"><p>| copyright © 2023 Daniel Aukes. All Rights Reserved. |</p><p><a href=https://github.com/danb0b/danb0b.github.io/edit/master/content/work-blog/2023-12-01-servo-modeling/index.md>Edit this Page</a></p></div></div></div></footer><script>var indexURL="https://www.danaukes.com/index.json"</script><script src=https://www.danaukes.com/plugins/glightbox/js/glightbox.js></script><script src=https://www.danaukes.com/plugins/jQuery/jquery.min.js></script><script src=https://www.danaukes.com/plugins/bootstrap/bootstrap.min.js></script><script src=https://www.danaukes.com/plugins/slick/slick.min.js></script><script src=https://www.danaukes.com/plugins/venobox/venobox.min.js></script><script src=https://www.danaukes.com/plugins/search/fuse.min.js></script><script src=https://www.danaukes.com/plugins/search/mark.js></script><script src=https://www.danaukes.com/plugins/search/search.js></script><script src=https://www.danaukes.com/js/script.min.js></script><script>var lightboxDescription,lightboxVideo,lightboxInlineIframe,lightbox=GLightbox();lightbox.on("open",e=>{console.log("lightbox opened")}),lightboxDescription=GLightbox({selector:".glightbox2"}),lightboxVideo=GLightbox({selector:".glightbox3"}),lightboxVideo.on("slide_changed",({prev:e,current:t})=>{console.log("Prev slide",e),console.log("Current slide",t);const{slideIndex:s,slideNode:o,slideConfig:i,player:n}=t;n&&(n.ready||n.on("ready",e=>{}),n.on("play",e=>{console.log("Started play")}),n.on("volumechange",e=>{console.log("Volume change")}),n.on("ended",e=>{console.log("Video ended")}))}),lightboxInlineIframe=GLightbox({selector:".glightbox4"})</script></body></html>